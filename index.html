<!doctype html>
<html lang="en" data-theme="dark">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>301.st · Auth</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="alternate icon" type="image/x-icon" href="/favicon.ico" />
    <link rel="stylesheet" href="/css/theme.css" />
    <link rel="stylesheet" href="/css/layout.css" />
    <link rel="stylesheet" href="/css/site.css" />

    <!-- Early auth check: redirect authenticated users to dashboard
         This serves as a fallback for non-Cloudflare deployments.
         On CF Workers, the redirect happens at worker.ts before this runs. -->
    <style>
      body { opacity: 0; transition: opacity 0.15s ease-in; }
      body.auth-checked { opacity: 1; }
    </style>
    <script>
      (async function() {
        try {
          // Quick session check via refresh endpoint
          const res = await fetch('https://api.301.st/auth/refresh', {
            method: 'POST',
            credentials: 'include',
            signal: AbortSignal.timeout(3000) // 3s timeout
          });

          if (res.ok) {
            // Valid session - set welcome message for dashboard
            try {
              const notice = {
                type: 'success',
                message: 'Welcome back! You\'re already logged in.'
              };
              window.sessionStorage.setItem('globalNotice', JSON.stringify(notice));
            } catch {}

            // Redirect to dashboard
            window.location.replace('/dashboard.html');
            return; // Don't show login page
          }
        } catch (err) {
          // No session or network error - continue to login page
          console.debug('Auth check:', err.message || 'No active session');
        }

        // No valid session - show login page
        document.body.classList.add('auth-checked');
      })();
    </script>
  </head>
  <body>
    <header class="site-header" role="banner">
{{> header-top}}

      <div class="utility-bar">
        <div class="page-shell utility-bar__inner">
          <div class="utility-left">
            <nav class="breadcrumbs" aria-label="Breadcrumb">
              <a href="/" class="crumb"
                ><span class="icon" data-icon="mono/home"></span> <span data-i18n="layout.nav.home">Home</span></a
              >
              <span class="sep" aria-hidden="true">›</span>
              <span class="crumb is-current" data-i18n="layout.nav.login">Login</span>

              <span class="badges">
                <span class="badge badge--success" data-i18n="auth.hero.eyebrow">Production</span>
              </span>
            </nav>
          </div>

{{> header-utility}}
        </div>
      </div>
    </header>

{{> global-notice}}

    <main class="page">
      <div class="page-shell">
        <header class="page-header">
          <h1 class="h1" data-i18n="auth.hero.title">Access 301.st</h1>
          <p class="auth-subtitle" data-i18n="auth.hero.subtitle">
            Use email and password to access your account or request a reset.
          </p>
        </header>
        <section data-route="auth" id="auth">
          <div class="auth-shell">
            <div class="auth-grid">
              <section class="auth-card">

              <nav
                class="auth-tabs btn-chip-group"
                role="tablist"
                data-i18n-aria="layout.headerTabsLabel"
                aria-label="Authentication actions"
              >
                <button
                  type="button"
                  class="tabs__trigger btn-chip is-active"
                  data-auth-tab="login"
                  data-route-link="login"
                  data-i18n="layout.nav.login"
                >
                  Login
                </button>
                <button type="button" class="tabs__trigger btn-chip" data-auth-tab="register" data-route-link="register" data-i18n="layout.nav.register">
                  Register
                </button>
                <button type="button" class="tabs__trigger btn-chip" data-auth-tab="reset" data-route-link="reset" data-i18n="layout.nav.reset">
                  Forgot password?
                </button>
              </nav>

              <div data-auth-views>
                <section class="auth-view" data-auth-view="login" aria-hidden="false">
                  <form id="auth-login-form" data-form="login" class="auth-form">
                    <div class="avatar-preview">
                      <div class="avatar-ring" data-avatar-container>
                        <img class="avatar-icon" src="/img/anonymous-avatar.svg" alt="" aria-hidden="true" />
                      </div>
                      <p class="avatar-meta" data-avatar-label data-i18n="auth.login.avatarPlaceholder">
                        Enter email
                      </p>
                    </div>

                    <div class="field">
                      <label class="field-label" for="signin-email" data-i18n="auth.login.emailLabel">Email</label>
                      <input
                        class="input"
                        id="signin-email"
                        name="email"
                        type="email"
                        autocomplete="email"
                        required
                        data-avatar-source
                        aria-describedby="login-status"
                      />
                    </div>

                    <div class="field">
                      <label class="field-label" for="signin-password" data-i18n="auth.login.passwordLabel">Password</label>
                      <div class="password-field" data-password-field>
                        <input
                          class="input"
                          id="signin-password"
                          name="password"
                          type="password"
                          autocomplete="current-password"
                          required
                          aria-describedby="login-status"
                        />
                        <button
                          type="button"
                          class="password-toggle"
                          data-password-toggle
                          aria-label="Show password"
                        >
                          <svg class="icon" aria-hidden="true">
                            <use href="#i-mono-eye"></use>
                          </svg>
                        </button>
                      </div>
                    </div>

                    <div class="auth-status" id="login-status" data-type="pending" data-form-status="login" data-i18n="auth.login.statusDefault" role="status" aria-live="polite">
                      Enter your email and password to sign in.
                    </div>

                    <div class="auth-actions">
                      <button
                        type="submit"
                        class="btn btn--primary"
                        data-auth-submit="login"
                        data-i18n="auth.login.submit"
                        data-i18n-aria="auth.login.submitAria"
                        aria-label="Sign in to 301.st"
                      >
                        Sign in
                      </button>
                      <a
                        href="#register"
                        class="btn btn--ghost"
                        data-auth-switch="register"
                        data-route-link="register"
                        data-i18n="auth.login.linkToRegister"
                      >
                        Create account
                      </a>
                    </div>

                    <div class="auth-links">
                      <a href="#register" data-auth-switch="register" data-route-link="register" data-i18n="auth.login.linkToRegister"
                        >Create account</a
                      >
                      <a href="#reset" data-auth-switch="reset" data-route-link="reset" data-i18n="auth.login.linkToReset"
                        >Forgot password?</a
                      >
                    </div>

                    <div class="auth-social" aria-label="Social sign-in options">
                      <div class="auth-social__buttons">
                        <button
                          type="button"
                        class="btn btn--social btn--social-google"
                          data-social="google"
                        >
                          <span class="icon" aria-hidden="true">
                            <svg>
                              <use href="#i-brand-google"></use>
                            </svg>
                          </span>
                          <span data-social-label>Continue with Google</span>
                        </button>

                        <button
                          type="button"
                          class="btn btn--social btn--social-github"
                          data-social="github"
                        >
                          <span class="icon" aria-hidden="true">
                            <svg>
                              <use href="#i-brand-github"></use>
                            </svg>
                          </span>
                          <span data-social-label>Continue with GitHub</span>
                        </button>
                      </div>
                    </div>
                  </form>
                </section>

                <section class="auth-view" data-auth-view="register" hidden aria-hidden="true">
                  <form data-form="register" class="auth-form">
                    <div class="avatar-preview">
                      <div class="avatar-ring" data-avatar-container>
                        <img class="avatar-icon" src="/img/anonymous-avatar.svg" alt="" aria-hidden="true" />
                      </div>
                      <p class="avatar-meta" data-avatar-label data-i18n="auth.login.avatarPlaceholder">
                        Enter email
                      </p>
                    </div>

                    <div class="field">
                      <label class="field-label" for="register-email" data-i18n="auth.login.emailLabel">Email</label>
                      <input class="input" id="register-email" name="email" type="email" autocomplete="email" required aria-describedby="register-status" data-avatar-source />
                    </div>
                    <div class="field">
                      <label class="field-label" for="register-password" data-i18n="auth.login.passwordLabel">Password</label>
                      <div class="password-field" data-password-field>
                        <input
                          class="input"
                          id="register-password"
                          name="password"
                          type="password"
                          autocomplete="new-password"
                          required
                          aria-describedby="register-status"
                        />
                        <button
                          type="button"
                          class="password-toggle"
                          data-password-toggle
                          aria-label="Show password"
                        >
                          <svg class="icon" aria-hidden="true">
                            <use href="#i-mono-eye"></use>
                          </svg>
                        </button>
                    </div>
                    </div>

                    <div
                      class="auth-status"
                      data-type="pending"
                      data-form-status="register"
                      id="register-status"
                      data-i18n="auth.register.passwordHint"
                      role="status"
                      aria-live="polite"
                    >
                      Must contain upper & lower case letters and at least one digit.
                    </div>

                    <div class="auth-actions">
                      <button
                        type="submit"
                        class="btn btn--primary"
                        data-auth-submit="register"
                        data-i18n="auth.register.submit"
                        data-i18n-aria="auth.register.submitAria"
                        aria-label="Create your 301.st account"
                      >
                        Create account
                      </button>
                      <a href="#login" class="btn btn--ghost" data-auth-switch="login" data-route-link="login" data-i18n="auth.links.toLogin"
                        >Back to login</a
                      >
                    </div>
                  </form>
                </section>

                <section class="auth-view" data-auth-view="reset" hidden aria-hidden="true">
                  <div data-reset-mode="request">
                    <form data-form="reset-request" class="auth-form">
                      <div class="avatar-preview">
                        <div class="avatar-ring" data-avatar-container>
                          <img class="avatar-icon" src="/img/anonymous-avatar.svg" alt="" aria-hidden="true" />
                        </div>
                        <p class="avatar-meta" data-avatar-label data-i18n="auth.login.avatarPlaceholder">
                          Enter email
                        </p>
                      </div>

                      <div class="field">
                        <label class="field-label" for="reset-email" data-i18n="auth.login.emailLabel">Email</label>
                        <input
                          class="input"
                          id="reset-email"
                          name="value"
                          type="email"
                          autocomplete="email"
                          required
                          aria-describedby="reset-status"
                          data-avatar-source
                        />
                      </div>

                      <input type="hidden" name="type" value="email" />

                      <div
                        class="auth-status"
                        data-type="pending"
                        data-form-status="reset-request"
                        id="reset-status"
                        data-i18n="auth.reset.statusDefault"
                        role="status"
                        aria-live="polite"
                      >
                        We'll send you a link to set a new password.
                      </div>

                      <div class="auth-actions">
                        <button
                          type="submit"
                        class="btn btn--primary"
                        data-i18n="auth.reset.requestButton"
                          data-i18n-aria="auth.reset.requestAria"
                          aria-label="Request password reset link"
                        >
                          Request reset link
                        </button>
                      <a
                        href="#login"
                        class="btn btn--ghost"
                        data-auth-switch="login"
                        data-route-link="login"
                        data-i18n="auth.reset.linkToLogin"
                        >Back to login</a
                      >
                    </div>
                  </form>
                </div>

                  <div data-reset-mode="confirm" hidden>
                    <header class="auth-section__header">
                      <h2 class="auth-title" data-i18n="auth.resetConfirm.title">Set a new password</h2>
                      <p class="auth-subtitle" data-i18n="auth.resetConfirm.subtitle">
                        Choose a new password for your 301.st account.
                      </p>
                    </header>

                    <form data-form="reset-confirm" class="auth-form">
                      <div
                        class="auth-status"
                        data-type="pending"
                        data-form-status="reset-confirm"
                        id="reset-confirm-status"
                        data-i18n="auth.resetConfirm.statusDefault"
                        role="status"
                        aria-live="polite"
                      >
                        Make sure passwords match and are strong enough.
                      </div>

                      <div class="field">
                        <label class="field-label" for="reset-password" data-i18n="auth.resetConfirm.passwordLabel"
                          >New password</label
                        >
                        <div class="password-field" data-password-field>
                          <input
                            class="input"
                            id="reset-password"
                            name="password"
                            type="password"
                            autocomplete="new-password"
                            required
                            aria-describedby="reset-confirm-status"
                          />
                          <button
                            type="button"
                            class="password-toggle"
                            data-password-toggle
                            aria-label="Show password"
                          >
                            <svg class="icon" aria-hidden="true">
                              <use href="#i-mono-eye"></use>
                            </svg>
                          </button>
                        </div>
                      </div>

                      <div class="field">
                        <label class="field-label" for="reset-password-confirm" data-i18n="auth.resetConfirm.confirmLabel"
                          >Repeat password</label
                        >
                        <div class="password-field" data-password-field>
                          <input
                            class="input"
                            id="reset-password-confirm"
                            name="password_confirm"
                            type="password"
                            autocomplete="new-password"
                            required
                            aria-describedby="reset-confirm-status"
                          />
                          <button
                            type="button"
                            class="password-toggle"
                            data-password-toggle
                            aria-label="Show password"
                          >
                            <svg class="icon" aria-hidden="true">
                              <use href="#i-mono-eye"></use>
                            </svg>
                          </button>
                        </div>
                      </div>

                      <div class="auth-actions">
                        <button
                          type="submit"
                          class="btn btn--primary"
                          data-i18n="auth.resetConfirm.submit"
                          data-i18n-aria="auth.resetConfirm.submitAria"
                          aria-label="Update password and continue"
                        >
                          Update password
                        </button>
                        <a
                          href="#login"
                          class="btn btn--ghost"
                          data-auth-link="login"
                          data-i18n="auth.links.toLogin"
                        >
                          Back to login
                        </a>
                      </div>
                    </form>
                  </div>
                </section>

                <section class="auth-view" data-auth-view="verify" hidden aria-hidden="true">
                  <h2 data-i18n="auth.verify.title">Verifying…</h2>
                  <p class="muted" data-i18n="auth.verify.subtitle">
                    We are validating the link from your email. This takes a few seconds.
                  </p>
                  <div data-verify-status class="auth-status" hidden></div>
                </section>
              </div>

              <div class="auth-status" data-type="pending" data-turnstile-status role="status" aria-live="polite">
                <div class="turnstile-widget" role="img" aria-describedby="turnstile-help"></div>
                <p class="text-muted" id="turnstile-help" data-i18n="auth.turnstile.hint">
                  Turnstile protects authorisation forms from bots.
                </p>
              </div>

              <div class="session-block">
                <div data-onlogin hidden>
                  <p class="muted" data-i18n="auth.session.active">Session is active.</p>
                  <p data-i18n-html="auth.session.signedInAs">
                    You are signed in as <strong data-auth-email data-user-email></strong>. Current role:
                    <span data-user-role>client:owner</span>.
                  </p>
                  <div class="auth-actions">
                    <button class="btn btn--ghost" data-action="logout" data-i18n="auth.session.logout" aria-label="Log out">
                      Log out
                    </button>
                  </div>
                </div>
                <div data-onlogout hidden>
                  <p class="muted" data-i18n="auth.messages.notAuthenticated">You are not authenticated yet.</p>
                </div>
              </div>
            </section>

            <section class="stack" style="gap: var(--space-3)">
              <aside class="card card--soft card--accent" data-onlogout hidden id="promo-card">
                <header class="card__header">
                  <h3 class="h5">What's Inside Your Dashboard</h3>
                  <p class="text-sm text-muted">Production-ready infrastructure orchestration built for scale.</p>
                </header>
                <div class="card__body">
                  <ul class="list--spaced">
                    <li><span class="icon" data-icon="mono/directions"></span> Bulk redirect management across domains (edge rules, &lt;50ms)</li>
                    <li><span class="icon" data-icon="mono/dns"></span> Manage hundreds of domains across multiple registrars</li>
                    <li><span class="icon" data-icon="mono/directions-fork"></span> Full-featured TDS with geo-targeting and A/B testing</li>
                    <li><span class="icon" data-icon="brand/cloudflare"></span> Multi-account Cloudflare orchestration with bulk operations</li>
                  </ul>
                </div>
                <footer class="card__footer">
                  <div style="display: flex; gap: var(--space-2); flex-wrap: wrap">
                    <a class="btn-chip" href="#register">
                      <span class="icon" data-icon="mono/user"></span>
                      <span class="btn-chip__label">Create account</span>
                    </a>
                    <button class="btn-chip" type="button" data-social="google">
                      <span class="icon" data-icon="brand/google"></span>
                      <span class="btn-chip__label" data-social-label>Google</span>
                    </button>
                    <button class="btn-chip" type="button" data-social="github">
                      <span class="icon" data-icon="brand/github"></span>
                      <span class="btn-chip__label" data-social-label>GitHub</span>
                    </button>
                  </div>
                </footer>
              </aside>

              <section class="card card--panel card--compact" data-onlogout hidden>
                <header class="card__header"><h3 class="h6">Quick Start</h3></header>
                <div class="card__body">
                  <div class="step-flow">
                    <div class="step-pill">
                      <span class="step-number step-number--cf">1</span>
                      <span class="step-text">Connect Cloudflare</span>
                    </div>
                    <span class="step-separator">→</span>
                    <div class="step-pill">
                      <span class="step-number">2</span>
                      <span class="step-text">Import & configure</span>
                    </div>
                    <span class="step-separator">→</span>
                    <div class="step-pill">
                      <span class="step-number">3</span>
                      <span class="step-text">Launch</span>
                    </div>
                  </div>
                </div>
              </section>
            </section>
          </div>
        </div>
      </section>
      </div>

    </main>

{{> footer}}

    <script type="module" src="/src/main.ts"></script>
  </body>
</html>
