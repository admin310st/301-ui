<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Reset password — 301.st</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="alternate icon" type="image/x-icon" href="/favicon.ico" />
    <link rel="stylesheet" href="/css/theme.css" />
    <link rel="stylesheet" href="/css/site.css" />
  </head>
  <body class="app auth-layout">
    <header class="site-header site-header--plain">
      <div class="container header-bar">
        <a class="brand" href="/" aria-label="301.st brand">
          <svg class="brand__logo" style="color: var(--blue-neon)" width="120" height="48" viewBox="0 0 120 48" fill="none" xmlns="http://www.w3.org/2000/svg" aria-label="301.st">
            <path d="M63.36.563C65.24.311 69.714.498 71.785.47c2.88.147 5.955-.22 8.808.117 6.783.802 11.57 5.176 14.063 11.14-2.475.035-5.862-.245-8.26.201-.331.061-.844.534-1.105.774-1.307-1.425-3.009-2.733-4.95-3.123-2.78-.56-5.81-.186-8.647-.26-2.022.025-4.073-.048-6.09.022-15.278.537-15.615 28.598-.304 29.31 2.312.106 4.813.041 7.141.038 2.491-.004 5.19.094 7.664-.07 2.426-.288 3.625-.972 5.531-2.339.341.308.807.583 1.2.833 2.47.114 5.401.033 7.902.026-2.352 5.292-7.052 9.72-12.96 10.557-2.5.354-5.631.153-8.132.167-6.836.036-13.78.658-19.483-3.92-10.637-8.011-12.008-25.348-4.321-35.796 3.173-4.313 8.256-6.851 13.52-7.58z" fill="currentColor"/>
            <path d="M119.706 15.228c-.025-.53-.067-1.064-.296-1.549-1.457-.565-12.882-.402-15.113-.332-5.47.171-11.85-.25-17.27.042-.73.574-.982.912-1.037 1.867-.134 2.384.043 4.847.034 7.235-.014 3.611-.063 7.201-.042 10.81.012 1.222.325 1.89 1.678 1.92 3.799.092 7.611.045 11.412.04l19.737-.015c.429-.23.652-.416.797-.901.206-.69.189-17.16.1-19.117M95.331 32.503h-7.702l.01-3.028c1.588-.005 11.653.268 12.379-.459.316-.314.377-.924.445-1.352q-.026-.076-.056-.155l-.035-.085c-.224-.57-.413-.902-1.055-1.06-3.444-.84-11.422 1.706-11.57-4.045a4 4 0 0 1-.05-.485c-.222-5.153 4.483-4.822 8.166-4.727 2.195.057 4.451.06 6.648.042l-.012 2.807c-1.576 0-10.084-.294-10.972.375-.441.334-.487.849-.58 1.358.111.492.202 1.168.696 1.346 3.985 1.443 9.834-1.906 11.861 3.428 1.06 6.544-3.333 6.044-8.173 6.04m23.032-12.26c-1.003-.008-5.029-.196-5.628.223.027 1.575.146 4.742.007 6.264q.051 2.823.044 5.646l-3.497.017c.002-1.381-.065-3.954.038-5.244-.143-1.22-.064-5.546.007-6.825-.71-.21-4.248-.12-5.234-.11l.004-3.044 14.27.007zM.151.053 17.26.016c9.733-.012 24.345-.952 24.494 13.051.046 4.254-.25 6.99-3.32 10.258 3.725 2.904 4.472 4.905 4.637 9.531.575 16.123-13.197 15.054-24.463 15.03L.133 47.824c-.026-2.025-.502-8.1.52-9.395L2 38.311c4.95-.019 27.682 1.096 30.507-1.414 1.085-.965 1.493-2.477 1.505-3.891.013-1.276-.394-2.782-1.15-3.862-1.893-2.707-6.13-2.05-9.308-2.067-1.952-.015-3.905-.007-5.857-.007l.007-7.304c1.73-.006 3.459.01 5.19-.007 2.252-.023 5.228.314 6.856-1.383.882-.918 1.205-2.22 1.222-3.488.014-1.097-.283-2.238-1.053-3.063-1.706-1.827-4.734-1.454-7.025-1.477L7.51 10.34l.027 27.854c-.008 1.322-.1 2.673.019 3.992.069.757.305 1.604.888 2.086.622.515 1.465.646 2.245.68 1.372.061 2.748.023 4.122.027l-.005 3.008L.182 47.945Q.151 24 .151.053" fill="currentColor"/>
          </svg>
        </a>
      </div>
    </header>

    <main class="layout auth-layout">
      <section class="auth-layout__info">
        <header class="auth-header">
          <p class="auth-eyebrow">Security</p>
          <h1 class="auth-title">Set a new password</h1>
          <p class="auth-subtitle">
            You opened this page from a reset link. Choose a strong password you
            haven’t used before.
          </p>
        </header>

        <ul class="auth-hints">
          <li>Use at least 8 characters.</li>
          <li>Mix digits, uppercase and lowercase letters.</li>
          <li>Never reuse your old passwords.</li>
        </ul>
      </section>
      <section class="auth-layout__card">
        <div class="panel">
          <header class="panel__header">
            <p class="eyebrow">Reset verification</p>
            <h2 class="panel__title">We are validating your link</h2>
            <p class="muted">
              The reset link from your email must be confirmed before you can set a new password.
            </p>
          </header>

          <div id="status" class="form-status" role="status" aria-live="polite">
            Checking your reset link…
          </div>

          <form id="reset-form" class="auth-form" hidden aria-hidden="true" novalidate>
            <div class="form-grid">
              <label class="form-field">
                <span class="form-label">New password</span>
                <input
                  class="input"
                  id="password"
                  name="password"
                  type="password"
                  autocomplete="new-password"
                  required
                />
              </label>

              <label class="form-field">
                <span class="form-label">Repeat password</span>
                <input
                  class="input"
                  id="password_confirm"
                  name="password_confirm"
                  type="password"
                  autocomplete="new-password"
                  required
                />
              </label>
            </div>

            <button type="submit" class="btn btn--primary btn-full">Update password</button>

            <p class="form-footer">
              <a href="/auth#login">Back to login</a>
            </p>
          </form>
        </div>
      </section>
    </main>

    <script type="module">
      const API_ROOT = 'https://api.301.st/auth';

      const $ = (selector) => document.querySelector(selector);

      const statusBox = $('#status');
      const form = $('#reset-form');
      const passInput = $('#password');
      const pass2Input = $('#password_confirm');

      let csrfToken = '';

      function setStatus(type, text) {
        if (!statusBox) return;
        statusBox.textContent = text;
        statusBox.dataset.type = type;
      }

      function showForm(show) {
        if (!form) return;
        form.hidden = !show;
        form.setAttribute('aria-hidden', show ? 'false' : 'true');
      }

      function getResetTokenFromUrl() {
        const url = new URL(window.location.href);
        const type = url.searchParams.get('type')?.toLowerCase();
        const token = url.searchParams.get('token')?.trim();

        if (type !== 'reset' || !token) return null;

        try {
          url.searchParams.delete('token');
          const cleanPath = url.pathname + (url.search ? '?' + url.search : '') + url.hash;
          window.history.replaceState(null, '', cleanPath);
        } catch (err) {
          console.warn('Could not clean URL', err);
        }

        return token;
      }

      async function verifyResetLink() {
        const token = getResetTokenFromUrl();
        if (!token) {
          setStatus('error', 'Reset link is invalid or missing. Please request a new reset email.');
          showForm(false);
          return;
        }

        setStatus('pending', 'Validating your reset link…');

        try {
          const res = await fetch(API_ROOT + '/verify', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ token }),
          });

          const data = await res.json();

          if (!res.ok || !data || !data.ok || data.type !== 'reset') {
            throw data;
          }

          if (!data.csrf_token) {
            throw { message: 'Missing CSRF token' };
          }

          csrfToken = data.csrf_token;

          setStatus('success', 'Reset link verified. Please set a new password.');
          showForm(true);
          passInput?.focus();
        } catch (err) {
          console.error('verify reset failed', err);
          const msgCode = err?.message || err?.error || '';

          let text = 'Reset link is invalid or expired. Please request a new reset email.';

          if (msgCode === 'expired_token') {
            text = 'Reset link has expired. Please request a new one.';
          }

          setStatus('error', text);
          showForm(false);
        }
      }

      async function submitNewPassword(event) {
        event.preventDefault();
        if (!form) return;

        const password = passInput?.value.trim() || '';
        const password2 = pass2Input?.value.trim() || '';

        if (!password || password.length < 8) {
          setStatus('error', 'Password must be at least 8 characters long.');
          passInput?.focus();
          return;
        }

        if (password !== password2) {
          setStatus('error', 'Passwords do not match.');
          pass2Input?.focus();
          return;
        }

        if (!csrfToken) {
          setStatus('error', 'Reset session expired. Please start the reset flow again.');
          showForm(false);
          return;
        }

        setStatus('pending', 'Saving your new password…');

        try {
          const res = await fetch(API_ROOT + '/confirm_password', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({
              password,
              csrf_token: csrfToken,
            }),
          });

          const data = await res.json();

          if (!res.ok || !data || !data.ok) {
            const code = data?.code || data?.error || data?.message || '';

            if (code === 'password_too_weak') {
              setStatus('error', 'Password is too weak. Please use a stronger one.');
              passInput?.focus();
              return;
            }

            if (code === 'password_reused') {
              setStatus('error', 'This password was used before. Please choose a different one.');
              passInput?.focus();
              return;
            }

            if (
              code === 'csrf_invalid' ||
              code === 'reset_session_expired' ||
              code === 'reset_session_missing'
            ) {
              setStatus('error', 'Reset session expired. Please start the reset flow again.');
              showForm(false);
              return;
            }

            throw data;
          }

          setStatus('success', 'Your password has been updated. You can now log in.');
          showForm(false);

          setTimeout(() => {
            window.location.href = '/auth#login';
          }, 1500);
        } catch (err) {
          console.error('confirm_password failed', err);
          setStatus('error', 'Could not update password. Please try again later.');
        }
      }

      document.addEventListener('DOMContentLoaded', () => {
        verifyResetLink();
        form?.addEventListener('submit', submitNewPassword);
      });
    </script>
  </body>
</html>
