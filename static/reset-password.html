<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Reset password — 301.st</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="alternate icon" type="image/x-icon" href="/favicon.ico" />
    <link rel="stylesheet" href="/css/theme.css" />
    <link rel="stylesheet" href="/css/site.css" />
  </head>
  <body class="app auth-layout">
    <main class="layout auth-layout">
      <section class="auth-layout__info">
        <header class="auth-header">
          <p class="auth-eyebrow">Security</p>
          <h1 class="auth-title">Set a new password</h1>
          <p class="auth-subtitle">
            You opened this page from a reset link. Choose a strong password you
            haven’t used before.
          </p>
        </header>

        <ul class="auth-hints">
          <li>Use at least 8 characters.</li>
          <li>Mix digits, uppercase and lowercase letters.</li>
          <li>Never reuse your old passwords.</li>
        </ul>
      </section>

      <section class="auth-layout__card">
        <div id="status" class="form-status" role="status" aria-live="polite">
          Checking your reset link…
        </div>

        <form id="reset-form" class="auth-form" hidden aria-hidden="true" novalidate>
          <label class="form-field">
            <span class="form-label">New password</span>
            <input
              id="password"
              name="password"
              type="password"
              autocomplete="new-password"
              required
            />
          </label>

          <label class="form-field">
            <span class="form-label">Repeat password</span>
            <input
              id="password_confirm"
              name="password_confirm"
              type="password"
              autocomplete="new-password"
              required
            />
          </label>

          <button type="submit" class="btn btn-primary">Update password</button>

          <p class="form-footer">
            <a href="/auth#login">Back to login</a>
          </p>
        </form>
      </section>
    </main>

    <script type="module">
      const API_ROOT = 'https://api.301.st/auth';

      const $ = (selector) => document.querySelector(selector);

      const statusBox = $('#status');
      const form = $('#reset-form');
      const passInput = $('#password');
      const pass2Input = $('#password_confirm');

      let csrfToken = '';

      function setStatus(type, text) {
        if (!statusBox) return;
        statusBox.textContent = text;
        statusBox.dataset.type = type;
      }

      function showForm(show) {
        if (!form) return;
        form.hidden = !show;
        form.setAttribute('aria-hidden', show ? 'false' : 'true');
      }

      function getResetTokenFromUrl() {
        const url = new URL(window.location.href);
        const type = url.searchParams.get('type');
        const token = url.searchParams.get('token');

        if (type !== 'reset' || !token) return null;

        try {
          url.searchParams.delete('token');
          const cleanPath = url.pathname + (url.search ? '?' + url.search : '') + url.hash;
          window.history.replaceState(null, '', cleanPath);
        } catch (err) {
          console.warn('Could not clean URL', err);
        }

        return token;
      }

      async function verifyResetLink() {
        const token = getResetTokenFromUrl();
        if (!token) {
          setStatus('error', 'Reset link is invalid or missing. Please request a new reset email.');
          showForm(false);
          return;
        }

        setStatus('pending', 'Validating your reset link…');

        try {
          const res = await fetch(API_ROOT + '/verify', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ token }),
          });

          const data = await res.json();

          if (!res.ok || !data || !data.ok || data.type !== 'reset') {
            throw data;
          }

          if (!data.csrf_token) {
            throw { message: 'Missing CSRF token' };
          }

          csrfToken = data.csrf_token;

          setStatus('success', 'Reset link verified. Please set a new password.');
          showForm(true);
          passInput?.focus();
        } catch (err) {
          console.error('verify reset failed', err);
          const msgCode = err?.message || err?.error || '';

          let text = 'Reset link is invalid or expired. Please request a new reset email.';

          if (msgCode === 'expired_token') {
            text = 'Reset link has expired. Please request a new one.';
          }

          setStatus('error', text);
          showForm(false);
        }
      }

      async function submitNewPassword(event) {
        event.preventDefault();
        if (!form) return;

        const password = passInput?.value.trim() || '';
        const password2 = pass2Input?.value.trim() || '';

        if (!password || password.length < 8) {
          setStatus('error', 'Password must be at least 8 characters long.');
          passInput?.focus();
          return;
        }

        if (password !== password2) {
          setStatus('error', 'Passwords do not match.');
          pass2Input?.focus();
          return;
        }

        if (!csrfToken) {
          setStatus('error', 'Reset session expired. Please start the reset flow again.');
          showForm(false);
          return;
        }

        setStatus('pending', 'Saving your new password…');

        try {
          const res = await fetch(API_ROOT + '/confirm_password', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({
              password,
              csrf_token: csrfToken,
            }),
          });

          const data = await res.json();

          if (!res.ok || !data || !data.ok) {
            const code = data?.code || data?.error || data?.message || '';

            if (code === 'password_too_weak') {
              setStatus('error', 'Password is too weak. Please use a stronger one.');
              passInput?.focus();
              return;
            }

            if (code === 'password_reused') {
              setStatus('error', 'This password was used before. Please choose a different one.');
              passInput?.focus();
              return;
            }

            if (
              code === 'csrf_invalid' ||
              code === 'reset_session_expired' ||
              code === 'reset_session_missing'
            ) {
              setStatus('error', 'Reset session expired. Please start the reset flow again.');
              showForm(false);
              return;
            }

            throw data;
          }

          setStatus('success', 'Your password has been updated. You can now log in.');
          showForm(false);

          setTimeout(() => {
            window.location.href = '/auth#login';
          }, 1500);
        } catch (err) {
          console.error('confirm_password failed', err);
          setStatus('error', 'Could not update password. Please try again later.');
        }
      }

      document.addEventListener('DOMContentLoaded', () => {
        verifyResetLink();
        form?.addEventListener('submit', submitNewPassword);
      });
    </script>
  </body>
</html>
