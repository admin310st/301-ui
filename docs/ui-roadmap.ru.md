# UI Roadmap 301.st — кабинет, интеграции и управление трафиком

Этот документ описывает, как будет развиваться интерфейс 301.st с точки зрения
пользовательского кабинета: от авторизации и базовых форм до управления
интеграциями, доменами, потоками (TDS), сайтами и редиректами.

Главная идея:

- **Интеграции** — фундамент, источник ресурсов (CF-аккаунты, доменные провайдеры и т.д.).
- **Домены** — домены (и в будущем другие сущности), приходящие из интеграций.
- **Проекты** — логические рабочие папки, где пользователь собирает домены, потоки и сайты.
- **Потоки (Streams/TDS)** — логика распределения трафика.
- **Сайты (Sites)** — конечные площадки (whitepages/лендинги/сайты), куда доходят реальные пользователи.
- **Редиректы (Redirect Rules)** — отдельный слой простых правил перенаправления.
- **Админка (System/Jobs/Market)** — в самом конце, на тех же UI-кирпичиках.

При этом важно:

- под доменом, **зарезервированным под сайт**, пользователь может:
  - вести трафик напрямую на сайт (простой 301),
  - **или поднять поверх этого же домена TDS/клоаку**, где:
    - whitepage сайта будет одной из веток / fallback,
    - остальные ветки ведут на офферы/другие URL.

Мы не “светим” механику Cloudflare (Workers, Routes, KV, зоны) — UI оперирует
понятными сущностями: домены, сайты, потоки, редиректы.

Текущий фронтенд-стек:

- Vite + TypeScript + ESM-модули
- Cloudflare Workers (app.301.st) + статика (`public/`)
- Свои CSS-токены и дизайн-система (без Tailwind)
- SVG-иконки через спрайт (`icons-sprite.svg`)

Бэкенд-структура (упрощённо):

- `api/auth` — авторизация, сессии, OAuth
- `api/projects` — проекты
- `api/sites` — сайты
- `api/domains` — домены
- `api/redirects` — правила редиректов
- `api/tds` — TDS/потоки
- `api/integrations` — внешние интеграции (Cloudflare, регистраторы, мониторинг и пр.)
- `api/jobs` + `system/*` — фоновые задачи, очереди, бэкапы, health (для админки)

---

## 0. Базовый уровень — авторизация и инфраструктура (уже есть)

Любое изменение дизайн-системы требует пересобрать **все** демо-страницы в том же PR (style guide + примеры компонентов).

Цель: рабочий login/registration/reset-флоу и сборка через Vite+Workers.

Сделано / планируется:

- Страница авторизации:
  - регистрация, логин, logout;
  - подтверждение email (verify).
- Восстановление пароля:
  - запрос ссылки (reset),
  - переход по `/auth/verify?type=reset&token=...`,
  - форма ввода нового пароля,
  - защита через CSRF и reset-сессию.
- Интеграция Turnstile.
- Cloudflare Wizard (подключение аккаунта CF).
- Стек:
  - `npm run dev` — Vite dev server;
  - `npm run build` → `public/`;
  - deploy через Wrangler;
  - `/env` выдаёт публичные параметры (sitekey и т.п.).
- Иконки:
  - исходники в `static/img/icons-src/`,
  - сборка спрайта `icons-sprite.svg`, `icons-map.json`, `icons-preview.html`.

Это «нулевой» слой, на котором строится кабинет.

---

## 1. Общая модель сущностей

### 1.1. Интеграции (Integrations) — Уровень 0

Интеграции — это **источник ресурсов**:

- Cloudflare Accounts:
  - аккаунты с email, account_id,
  - дают доступ к зонам/доменам/роутам/Workers (механику скрываем).
- Domain Registrars:
  - Namecheap, Namesilo и др.,
  - дают информацию о регистрации/expiry доменов.
- Monitoring/Analytics:
  - HostTracker, аналитика и т.п. (позже).

Интеграции находятся **выше проектов** по смыслу:  
проекты используют домены, а домены привязаны к аккаунтам CF и регистраторов.

### 1.2. Domains (Домены) — Уровень 1

Каждый домен:

- принадлежит какому-то регистратору,
- привязан к определённому Cloudflare-аккаунту/зоне,
- может использоваться в разных проектах/потоках.

Ключевой момент:

- домен “принадлежит интеграциям” (CF + регистратор), а не проекту,
- проект только **использует** домен и может помечать его как “рабочий” в рамках проекта.

Домены могут находиться в разных состояниях:

- по регистрации: `active`, `expired`, `grace`, `parked`;
- по Cloudflare: `connected`, `sync_error`;
- по локальной логике 301.st:
  - `free` (не используется),
  - `attached_to_project`,
  - `attached_to_site` (зарезервирован под сайт),
  - `attached_to_stream` (используется как вход в поток),
  - `test`, `blocked`, `retired`.

> **Важно про “зарезервированный домен”:**  
> если домен привязан к сайту (site), это не мешает:
> - продолжать вести на сайт прямой трафик (простой 301),
> - **поднять поверх этого же домена TDS/клоаку**: в этом случае поток
>   (stream) принимает входящий трафик, решает:
>   - кому показать whitepage сайта,
>   - кого отправить дальше (оффер/CPA/другой URL),
>   - при этом домен в UI остаётся “привязанным к сайту”.

### 1.3. Проекты (Projects) — Уровень 2

Проект — **логическая рабочая папка** (workspace):

- объединяет Streams, Sites и набор доменов, которые в нём используются,
- не является “владельцем” доменов, а лишь помечает, какие домены относятся к этому проекту.

Примеры проектов:

- “RU Betting / Main Stack”
- “Crypto Casino / LatAm”
- “SEO Redirects / Drops”

### 1.4. Сайты (Sites) — Уровень 3A

Сайт — это **конечная площадка** для “живых” пользователей:

- whitepage;
- лендинг/прелендинг;
- блог/контентная страница;
- любой внешний URL, куда идёт “нормальный” трафик.

Сайт:

- живёт внутри проекта;
- может иметь несколько доменов, **зарезервированных под этот сайт**:
  - домен → простой редирект → сайт;
- может быть целевым для нескольких потоков (TDS);
- может существовать вообще без TDS (простой 301 → сайт).

При этом:

- домен, привязанный к сайту, может:
  - продолжать работать как обычный “сайт-домен”;
  - **параллельно использоваться как входная точка TDS/клоаки**:
    - поток “навешивается” на этот домен,
    - whitepage сайта становится одной из веток или fallback,
    - дополнительные ветки ведут на офферы/другие страницы.

То есть в терминах пользователя:

> “Я могу сначала зарезервировать домен под сайт,  
> а потом в любой момент включить поверх него поток/клоаку,  
> не меняя привязку домена к сайту.”

### 1.5. Потоки (Streams / TDS) — Уровень 3B

Поток = **TDS-логика**, аналог “стримов” в Keitaro:

- принимает трафик с одного или нескольких доменов;
- применяет условия:
  - GEO,
  - устройство (mobile/desktop),
  - OS/Browser (в будущем),
  - реферер (search/social/direct/custom),
  - прочие сигналы (бот/антибот, CF headers — позже);
- распределяет трафик:
  - на сайты (Sites),
  - на внешние URL (офферы),
  - по веткам с весами (%),
  - на fallback (часто — whitepage сайта).

Поток:

- живёт внутри проекта;
- использует домены (как точки входа);
- чаще всего заканчивается на сайт (или набор сайтов);
- **может работать поверх “зарезервированного под сайт” домена**:
  - в этом случае:
    - “нормальный” трафик получает whitepage (сайт),
    - “трафик под офферы” уходит в другие ветки TDS.

### 1.6. Редиректы (Redirect Rules) — Уровень 4

Отдельный слой “простых” перенаправлений:

- глобальные или проектные правила:
  - Source: domain/path/условия;
  - Target: URL (301/302/307);
- могут использоваться:
  - для быстрых переездов,
  - для “прямых” 301 без TDS,
  - для тех. маршрутов.

Редиректы **не заменяют потоки**, а работают параллельно:
- домен может быть привязан к:
  - Stream,
  - Site (простой redirect),
  - чистому Redirect Rule.

---

## 2. Навигация кабинета

Боковое меню (глобально):

```text
Integrations
  - Cloudflare Accounts
  - Domain Registrars
  - (дальше) Monitoring / Analytics

Domains

Projects
  - (список проектов)
  - Внутри проекта: Streams, Sites, Project Domains

Traffic
  - Redirect Rules (глобальный список)
  - Streams (глобальный список, если нужно)

Account

---------------------------------------
Admin (самый конец)
  - System / Health
  - Jobs / Queue
  - Logs / Webhooks
  - Market / Partner Integrations
````

---

## 3. Этапы реализации UI (по шагам)

### Этап 0.5 — Приведение UI к единому стандарту (Refactor & Cleanup)

**Цели:**

* Унифицировать чипы и кнопки
* Удалить устаревшие модификаторы (`btn-ghost`, `btn-danger`)
* Переписать демо-страницы под текущие гайдлайны
* Перевести контролы на типографическую систему (`rem`/`em`) и убрать фиксированные пиксельные высоты
* Зафиксировать в гайде, что любые новые формы/таблицы обязаны использовать общий рецепт контролов
* Ввести единый токенный слой (`--fs-control`, `--lh-control`, `--control-pad-*`, `--accent-*`, `--text-*`)
* Обновить документацию и привести к ней таблицы / хедеры / фильтры
* Создать тестовые кейсы на компоненты таблиц

Дополнительно для ближайшего шага:

* Перевести UI на новую типографическую систему контролов (rem/em-базу).
* Переписать все демо-страницы под единый рецепт.
* Запретить любые pixel-based paddings/heights в новых PR.
* Каждый UI-компонент считается корректным только если он выглядит пропорционально в ряду со всеми остальными контролами.

**Результат:**
Весь UI соответствует StyleGuide, таблицы выглядят консистентно, чипированные кнопки корректно отображаются в мобильных и десктопных версиях.

### Этап 1 — UI-kit, layout кабинета и базовая консистентность

**Цель:** зафиксировать визуальные примитивы и общий каркас, чтобы не плодить хаос верстки.

1. **CSS-токены и базовые стили**

   * Цвета, радиусы, отступы, типографика.
   * Переменные:

    * `--bg`, `--panel`, `--brand`, `--danger`, `--ok`, `--muted`, `--text`
    * `--radius`, `--radius-lg`, `--space-1…--space-6`, `--control-radius`
    * `--border-subtle`, `--border-strong`, `--shadow-soft`
    * `--input-bg`, `--input-border`, `--input-focus`.

2. **Компоненты-примитивы (классы)**

   * Кнопки:

     * `btn`, `btn--primary`, `btn--secondary`, `btn--ghost`, `btn--danger`, `btn--icon`.
   * Формы:

     * `field`, `field-label`, `field-help`, `field-error`,
     * `input`, `input--sm`, `input--mono`,
     * паттерн для статусов и ошибок.
   * Карточки:

     * `card`, `card-header`, `card-body`, `card-footer`,
     * модификаторы `card--muted`, `card--danger`.
   * Таблицы:

     * `table`, `table-head`, `table-row`, `table-cell`, `table-actions`.
   * Иконки:

     * `icon`, `icon-btn`, `icon-btn--ghost`.
   * Соц/бренд-кнопки:

     * `auth-social-btn`, `auth-social-btn--google`,
     * `auth-social-btn--github`, `auth-social-btn--cloudflare`.

3. **Layout кабинета**

   * Верхняя панель:

     * логотип/название,
     * текущий пользователь,
     * переключатель темы,
     * в будущем — выбор активного аккаунта.
   * Левый сайдбар с секциями:

     * Integrations, Domains, Projects, Traffic, Account.

4. **UI-preview**

   * `/icons-preview.html` — иконки.
   * `/ui-preview.html` — живой каталог компонентов:

     * кнопки, формы, карточки, таблицы, тосты, иконки.

---

### Этап 2 — Integrations и Domains (слой 0 и 1)

**Цель:** дать пользователю ощущение “я подключил свои аккаунты и вижу свои домены”.

- **UI style guide:** `/ui-style-guide.html` (only on app.301.st) — эталонный набор токенов и классов, который должны брать Codex и разработчики.
- Унифицировать размеры всех контролов (inputs, buttons, chips, table search) через общий набор токенов и классов (`control-md`, `.btn--md`, `.btn-chip`). Любые новые экраны должны ссылаться на существующие паттерны, а не вводить свои размеры.

#### 2.1. Экран “Integrations”

Вкладки или группы:

* Cloudflare Accounts:

  * список аккаунтов;
  * поля:

    * alias/name,
    * email,
    * account_id,
    * количество зон,
    * количество проектов, которые их используют,
    * статус (OK / error / reauth-needed),
    * время последнего успешного check/sync.
* Domain Registrars:

  * Namecheap, Namesilo и др.;
  * alias,
  * тип,
  * какие домены обслуживаются,
  * статус.

Действия:

* `Add integration`
* `Edit / Update keys`
* `Test connection`
* `Resync` (для CF — зоны, для регистраторов — домены).

#### 2.2. Экран “Domains (глобальный)”

Список доменов (из всех интеграций):

Колонки:

* Domain
* Cloudflare account / zone (кратко)
* Registrar (Namecheap/Namesilo/…)
* Project (если привязан)
* Attached as:

  * free / attached_to_project / attached_to_site / attached_to_stream / test / blocked / retired
* Status:

  * registration: active / expired / grace / parked;
  * CF: connected / sync error.
* Last sync (регистратор/CF).

Фильтры:

* по интеграции (CF-аккаунт, регистратор),
* по проекту,
* по типу привязки (к сайту, к потоку, свободный),
* по статусу.

Действия:

* Массовые:

  * `Sync with registrar`,
  * `Sync with Cloudflare`,
  * `Attach to project`,
  * `Mark as working/test/retired`.
* По строке:

  * открыть деталку домена,
  * перейти на проект/стрим/сайт, который его использует.

---

### Этап 3 — Projects, Sites, Streams (уровень 2 и 3)

**Цель:** дать пользователю рабочие “папки” (проекты) и два ключевых типа сущностей: сайты и потоки.

#### 3.1. Экран “Projects”

Список проектов:

* Колонки:

  * Name,
  * Description,
  * Streams (#),
  * Sites (#),
  * Domains (# привязанных),
  * Status (active/paused/error).
* Действия:

  * `Create project`,
  * `Open`.

Детальная страница проекта (tabs):

* Overview:

  * краткая статистика по Streams/Sites/Domains.
* Streams:

  * список потоков этого проекта.
* Sites:

  * список сайтов.
* Project Domains:

  * домены, привязанные к этому проекту (filter поверх глобальных доменов).

#### 3.2. Экран “Sites”

Список сайтов (внутри проекта):

* Колонки:

  * Site name,
  * URL / Base URL,
  * Attached domains (#),
  * Incoming streams (#),
  * Status.
* Действия:

  * `Add site`,
  * `Open`.

Детальная страница сайта:

* Основная информация:

  * URL,
  * описание,
  * проект.
* Домены, которые ведут напрямую на этот сайт (простые редиректы).
* Потоки, которые в итоге направляют трафик на этот сайт.
* Отдельный блок про “зарезервированные домены”:

  * какие домены зарезервированы под этот сайт,
  * какие из них уже используются как вход в TDS/клоаку.
* Кнопки:

  * `Attach domain to this site`,
  * `Create stream that ends on this site`,
  * `Enable TDS on this domain` (шорткат: создать поток и повесить его на домен, зарезервированный под сайт).

#### 3.3. Экран “Streams” (внутри проекта)

Список потоков:

* Колонки:

  * Stream name,
  * Type (simple / split / cloaking-сценарий),
  * Input domains (#),
  * Output sites/URLs (#),
  * Status (enabled/disabled),
  * Last change.
* Действия:

  * `Create stream`,
  * `Open`.

Детальная страница потока:

* Overview:

  * список входящих доменов,
  * краткое описание логики (GEO/device/referrer summary),
  * основные targets (sites/URLs),
  * явное указание, какие домены:

    * “висят поверх сайтов” (клоака поверх сайта),
    * или используются как чисто TDS-домены.
* Domains (tab):

  * какие домены “кормят” этот поток,
  * для каждого: привязан ли домен к какому-то сайту.
* Logic (TDS editor tab):

  * условия и ветки.
* Logs (позже):

  * активность/ошибки.

---

### Этап 4 — Traffic Rules: Redirects и TDS-логика

**Цель:** отрисовать работу “движка трафика”.

#### 4.1. Redirect Rules (глобально и/или по проекту)

Список redirect-правил:

* Колонки:

  * Name,
  * Scope: global / project / domain,
  * Source: domain + path/match,
  * Target: URL,
  * Code: 301/302/307,
  * Status: enabled/disabled + sync-status (если CF-managed).
* Действия:

  * `Create redirect rule`,
  * `Edit`,
  * `Clone`,
  * `Enable/Disable`,
  * `Sync with Cloudflare` (если route).

Форма редиректа:

* Уровень (scope),
* Привязка (к проекту/домену),
* Исходные условия (domain + path),
* Target URL,
* HTTP-code,
* опции: keep query / drop query.

#### 4.2. TDS-логика (Stream Logic Editor)

Для каждого Stream:

* Conditions:

  * Countries (multi-select),
  * Device (mobile/desktop),
  * Referrer (search / social / direct / custom),
  * в будущем — OS, Browser, BOT-флаги.
* Actions:

  * по каждой ветке:

    * target: Site или URL,
    * weight (%),
    * label (описание).
* Fallback:

  * куда отправлять всё остальное (часто — whitepage-сайт, если поток “сидит” поверх него).

Упор здесь — на UX: чтобы пользователи, привыкшие к Keitaro, чувствовали себя “как дома”.

---

### Этап 5 — Глобальное состояние (легкий store без Pinia)

**Цель:** аккуратно разделить состояние, не увлекаясь фреймворками.

Модули:

* `state/auth.ts`

  * user,
  * (в будущем) accounts,
  * `loadMe()`,
  * события `onAuthChange`.

* `state/ui.ts`

  * toasts,
  * global loading,
  * `showToast()`, `setGlobalLoading()`, `onUiChange()`.

* (опционально) лёгкие кэши:

  * `state/projects.ts`,
  * `state/domains.ts`,
  * `state/sites.ts`,
  * `state.streams.ts`,
  * с простыми get/fetch/subscribe.

Pinia и Vue оставляем как **опциональный следующий этап**, если кабинет станет очень сложным. Пока — чистый TS + модули.

---

### Этап 6 — Кабинет v2: UX-сахар и массовые действия

После того как базовый функционал живёт:

* Модалки для создания/редактирования Streams, Sites, Redirects.
* Массовые действия по доменам (attach/detach, sync, смена статуса).
* Inline-редактирование некоторых полей в таблицах.
* Улучшенные фильтры, поиск, сохранённые представления (views).
* Базовая аналитика (по потокам/доменам) — в виде summary-цифр.

---

### Этап 7 — Админка: System / Jobs / Logs / Market (самый конец)

Админская часть (для owner/ops):

* System / Health:

  * статус API/System/Webhook workers,
  * состояние D1/KV,
  * результаты cron-задач, backup, cleanup.
* Jobs / Queue:

  * очередь задач (sync доменов, sync зон, update redirects, re-check domains),
  * статус задач,
  * retry/cancel.
* Logs / Webhooks:

  * входящие Webhooks (HostTracker, CF Events и др.),
  * статус обработки.
* Market / Partner Integrations:

  * “магазин” интеграций и готовых пресетов:

    * CPA-сети,
    * шаблоны потоков,
    * pre-configured workers/flows.

Всё это строится на **тех же UI-кирпичах**, что и пользовательский кабинет:
карточки, таблицы, формы, тосты, модалки.

---

## Итог

* Интеграции — фундамент, из которого появляются домены и прочие ресурсы.
* Домен — расходник, который принадлежит интеграциям, а проекты/сайты/потоки его используют.
* Проект — рабочая папка.
* Сайт — конечная площадка (whitepage/лендинг).
* Поток (Stream/TDS) — логика маршрутизации трафика, которая может:

  * работать на “чистом” домене,
  * или **сидеть поверх домена, зарезервированного под сайт**, превращая его в клоаку/умный поток.
* Редиректы — слой быстрых простых правил.
* Админка и маркет — отдельный слой, складываем позже, когда базовый кабинет готов.
