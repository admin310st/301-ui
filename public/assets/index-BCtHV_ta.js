(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))r(s);new MutationObserver(s=>{for(const o of s)if(o.type==="childList")for(const i of o.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&r(i)}).observe(document,{childList:!0,subtree:!0});function n(s){const o={};return s.integrity&&(o.integrity=s.integrity),s.referrerPolicy&&(o.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?o.credentials="include":s.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function r(s){if(s.ep)return;s.ep=!0;const o=n(s);fetch(s.href,o)}})();const U="[301-ui]";function Q(e,...t){console.info(U,e,...t)}function h(e,...t){console.debug(U,e,...t)}let G=0;function M(e,t){try{typeof window.webstudioSetVariable=="function"&&window.webstudioSetVariable(e,t)}catch(n){console.debug("webstudio var failed",n)}}function X(){G+=1,M("authFetchBuster",`${G}`),ue().catch(e=>console.debug("buster fetch failed",e))}const Z=10*60*1e3;let v=null,L=new Set,y={token:null,user:null,loading:!1,isLoggedIn:!1};function ee(){L.forEach(e=>e({...y}))}function p(e){y={...y,...e},y.isLoggedIn=!!(y.token&&y.user),ee()}function te(e){return L.add(e),e({...y}),()=>L.delete(e)}function V(){return y.token}function m(e){p({token:e}),X(),M("authBearer",e?`Bearer ${e}`:""),e?re():$()}function x(){m(null)}function c(e){p({user:e})}async function I(){try{p({loading:!0});const e=await N();return c(e.user??e??null),e.user??e??null}catch(e){return h("Failed to load user",e),c(null),null}finally{p({loading:!1})}}async function ne(){try{const e=await B();e.access_token&&m(e.access_token),e.user&&c(e.user??null)}catch(e){h("Refresh failed",e),x(),c(null)}}function re(){$(),V()&&(v=setTimeout(ne,Z))}function $(){v&&clearTimeout(v),v=null}async function se(){try{p({loading:!0});const e=await B();if(e&&e.access_token){const t=e.access_token;m(t??null);const n=await N();c(n.user??n??null)}else m(null),c(null)}catch(e){h("Auth init failed",e),m(null),c(null)}finally{p({loading:!1}),Q("Auth state initialized")}}function oe(e,t,n="Request failed"){const r=typeof t=="object"&&t&&"message"in t?String(t.message):n,s=new Error(r);return s.status=e,s.body=t,s}async function ae(e){try{return await e.json()}catch(t){return console.debug("Failed to parse JSON",t),null}}const ie="https://api.301.st/auth";async function d(e,t={}){const n=new Headers(t.headers??{}),r=V();r&&!n.has("authorization")&&n.set("authorization",`Bearer ${r}`),t.body&&!(t.body instanceof FormData)&&n.set("content-type","application/json");const s=await fetch(`${ie}${e}`,{credentials:"include",...t,headers:n}),o=await ae(s);if(!s.ok)throw oe(s.status,o,s.statusText);return o??{}}async function ue(){try{await d("/me")}catch(e){h("Auth fetch buster failed",e)}}async function ce(e){const t=await d("/login",{method:"POST",body:JSON.stringify(e)});return t.access_token&&m(t.access_token),t.user&&c(t.user),t}async function B(){return d("/refresh",{method:"POST"})}async function le(e){return await d("/register",{method:"POST",body:JSON.stringify(e)})}async function de(e){return d("/reset_password",{method:"POST",body:JSON.stringify(e)})}async function fe(e){const t=await d("/verify",{method:"POST",body:JSON.stringify(e)});return"access_token"in t&&t.access_token&&m(t.access_token),"user"in t&&t.user&&c(t.user),t}async function he(e){return d("/confirm_password",{method:"POST",body:JSON.stringify(e)})}async function ge(){return d("/oauth/google/start")}async function me(){return d("/oauth/github/start")}async function ye(){try{await d("/logout",{method:"POST"})}catch(e){console.debug("Logout request failed",e)}x(),c(null)}async function N(){return d("/me")}const q="Пройдите проверку защиты (Turnstile).",A="0x4AAAAAACB-_l9VwF1M_QHU",E=new WeakMap;let H=A,S=null,k=null,F=0;const we=2*60*1e3;async function be(){try{const e=await fetch("/env",{cache:"no-store"});if(!e.ok)return A;const t=await e.json();return t.turnstileSitekey||t.turnstile_sitekey||A}catch(e){return h("Failed to load Turnstile sitekey",e),A}}function pe(){return typeof window>"u"?Promise.resolve(null):window.turnstile?Promise.resolve(window.turnstile):new Promise(e=>{if(!document.querySelector("script[data-turnstile]")){const r=document.createElement("script");r.src="https://challenges.cloudflare.com/turnstile/v0/api.js?render=explicit",r.async=!0,r.defer=!0,r.dataset.turnstile="true",document.head.appendChild(r)}const n=()=>e(window.turnstile||null);window.addEventListener("turnstileLoaded",n,{once:!0}),setTimeout(n,2e3)})}function Se(e){e instanceof Document&&(S==null||S.disconnect(),S=new MutationObserver(()=>K(e)),S.observe(e,{childList:!0,subtree:!0}))}async function _e(e=document){H=await be(),await pe()&&(K(e),Se(e))}function T(e,t){if(e){E.set(e,t);const n=e.querySelector('input[name="turnstile_token"]');n&&(n.value=t??"");return}k=t,F=t?Date.now():0}function K(e=document){const t=window.turnstile;!t||typeof t.render!="function"||(e.querySelectorAll(".turnstile-widget").forEach(n=>{if(n.dataset.tsRendered==="1")return;n.dataset.tsRendered="1";const r=n.closest("form"),s=t.render(n,{sitekey:H,callback:o=>{T(r,o);const i=r==null?void 0:r.querySelector('button[type="submit"]');i&&(i.disabled=!1)},"expired-callback":()=>{T(r,null)},"error-callback":()=>{T(r,null);const o=r==null?void 0:r.querySelector('button[type="submit"]');o&&(o.disabled=!0)}});typeof s=="string"&&(n.dataset.widgetId=s)}),e.querySelectorAll('form[data-form="login"], form[data-form="register"], form[data-form="reset-request"], form[data-form="reset-confirm"], form[data-form="cf-bootstrap"]').forEach(n=>{if(!n.querySelector('input[name="turnstile_token"]')){const r=document.createElement("input");r.type="hidden",r.name="turnstile_token",n.appendChild(r)}}))}function R(e){var n;return e&&E.has(e)?E.get(e)??null:k&&Date.now()-F<we?k:e&&((n=e.querySelector('input[name="turnstile_token"]'))==null?void 0:n.value)||null}function C(e){const t=window.turnstile;if(!(!t||typeof t.reset!="function")){if(k=null,F=0,e){const n=e.querySelector(".turnstile-widget");if(n!=null&&n.dataset.widgetId){t.reset(n.dataset.widgetId),T(e,null);return}}try{t.reset()}catch(n){h("Turnstile reset failed",n)}}}const b=(e,t=document)=>t.querySelector(e),_=(e,t=document)=>Array.from(t.querySelectorAll(e));function a(e,t,n){e.dataset.state=t;const r=b("[data-form-status], [data-status]",e);r&&(r.hidden=!1,r.dataset.type=t,n!==void 0&&(r.textContent=n));const s=e.querySelector('button[type="submit"]');s&&(s.dataset.labelReady||(s.dataset.labelReady=s.textContent??""),s.disabled=t==="pending",s.textContent=t==="pending"?s.dataset.labelLoading||"Please wait...":s.dataset.labelReady)}function l(e,t){const n=b("[data-global-message]");n&&(n.hidden=!1,n.dataset.type=e,n.textContent=t)}function ve(){const e=b("[data-global-message]");e&&(e.hidden=!0,e.textContent="",delete e.dataset.type)}function Ae(e){var n,r,s;const t=e;return((n=t==null?void 0:t.body)==null?void 0:n.code)||((r=t==null?void 0:t.body)==null?void 0:r.error)||((s=t==null?void 0:t.body)==null?void 0:s.message)||(t==null?void 0:t.message)||"Login failed"}function Te(e){switch(e){case"invalid_login":return"Неправильный логин или пароль. Попробуйте ещё раз или запросите восстановление доступа.";case"user_already_registered":return"Такой email уже зарегистрирован. Попробуйте войти или восстановить пароль.";case"password_too_weak":return"Пароль слишком слабый. Минимум 8 символов, буквы в разных регистрах и цифры.";case"turnstile_failed":return"Проверка защиты не пройдена. Обновите виджет и попробуйте ещё раз.";case"turnstile_required":return"Проверка защиты обязательна. Подтвердите Turnstile и попробуйте ещё раз.";default:return e}}function ke(e){const t=e.querySelector("[data-avatar-source]"),n=b("[data-avatar-label]"),r=b("[data-avatar-img]");if(!t)return;const s=o=>{const i=o.trim();n&&(n.textContent=i||"Укажите email"),r&&(r.src="/img/anonymous-avatar.svg")};s(t.value||""),t.addEventListener("input",o=>s(o.target.value))}async function qe(e){var o,i;e.preventDefault();const t=e.currentTarget;ve();const n=(o=t.querySelector('[name="email"]'))==null?void 0:o.value.trim(),r=((i=t.querySelector('[name="password"]'))==null?void 0:i.value)||"",s=R(t);if(!n||!r){a(t,"error","Введите email и пароль");return}if(!s){a(t,"error",q);return}try{a(t,"pending","Входим...");const u=await ce({email:n,password:r,turnstile_token:s||void 0});await I(),a(t,"success",u.message||"Вы вошли в 301.st"),l("success","Вы вошли в 301.st"),t.reset(),window.location.hash="#login"}catch(u){const g=Te(Ae(u));a(t,"error",g),C(t)}}function Re(){document.querySelectorAll('[data-form="login"]').forEach(e=>{e.dataset.bound!=="true"&&(e.dataset.bound="true",e.addEventListener("submit",qe),ke(e))})}function J(e){if(!e||e.length<8)return"Пароль должен быть не короче 8 символов.";const t=/[a-z]/.test(e),n=/[A-Z]/.test(e),r=/\d/.test(e);return!t||!n||!r?"Пароль должен содержать буквы в разных регистрах и хотя бы одну цифру.":null}function Le(e){var n,r,s;const t=e;return((n=t==null?void 0:t.body)==null?void 0:n.code)||((r=t==null?void 0:t.body)==null?void 0:r.error)||((s=t==null?void 0:t.body)==null?void 0:s.message)||(t==null?void 0:t.message)||"Registration failed"}function Ee(e){switch(e){case"invalid_login":return"Неправильный логин или пароль. Попробуйте ещё раз или запросите восстановление доступа.";case"user_already_registered":return"Такой email уже зарегистрирован. Попробуйте войти или восстановить пароль.";case"password_too_weak":return"Пароль слишком слабый. Минимум 8 символов, буквы в разных регистрах и цифры.";case"turnstile_failed":return"Проверка защиты не пройдена. Обновите виджет и попробуйте ещё раз.";case"turnstile_required":return"Проверка защиты обязательна. Подтвердите Turnstile и попробуйте ещё раз.";default:return e}}async function Oe(e){var i,u;e.preventDefault();const t=e.currentTarget,n=(i=t.querySelector('[name="email"]'))==null?void 0:i.value.trim(),r=((u=t.querySelector('[name="password"]'))==null?void 0:u.value)||"",s=R(t);if(!n||!r){a(t,"error","Нужны email и пароль");return}const o=J(r);if(o){a(t,"error",o);return}if(!s){a(t,"error",q);return}try{a(t,"pending","Создаём аккаунт...");const f=(await le({email:n,password:r,turnstile_token:s||void 0})).message||`Мы отправили письмо на ${n}. Перейдите по ссылке, чтобы завершить регистрацию.`;a(t,"success",f),l("info",f)}catch(g){a(t,"error",Ee(Le(g))),C(t)}}function Pe(){document.querySelectorAll('[data-form="register"]').forEach(e=>{e.dataset.bound!=="true"&&(e.dataset.bound="true",e.addEventListener("submit",Oe))})}let j=null;function z(e){j=e}function xe(){return j}function Ie(e){var n,r,s;const t=e;return((n=t==null?void 0:t.body)==null?void 0:n.code)||((r=t==null?void 0:t.body)==null?void 0:r.error)||((s=t==null?void 0:t.body)==null?void 0:s.message)||(t==null?void 0:t.message)||"Reset failed"}function Fe(e){switch(e){case"reset_session_required":return"Сессия сброса не найдена. Запросите сброс пароля ещё раз.";case"reset_session_expired":return"Ссылка для сброса устарела. Запросите новый сброс пароля.";case"csrf_token_invalid":return"Сессия сброса некорректна. Запросите новую ссылку.";case"password_reused":return"Новый пароль не должен совпадать с предыдущим.";case"password_too_weak":return"Пароль слишком слабый. Минимум 8 символов, буквы в разных регистрах и цифры.";default:return e}}async function Ce(e){var i,u;e.preventDefault();const t=e.currentTarget,n=((i=t.querySelector('[name="password"]'))==null?void 0:i.value)||"",r=((u=t.querySelector('[name="password_confirm"]'))==null?void 0:u.value)||"",s=xe();if(!s){a(t,"error","Ссылка для сброса просрочена. Запросите новую.");return}if(!n||!r){a(t,"error","Введите новый пароль");return}const o=J(n);if(o){a(t,"error",o);return}if(n!==r){a(t,"error","Пароли не совпадают");return}try{a(t,"pending","Обновляем пароль...");const f=(await he({password:n,csrf_token:s})).message||"Пароль обновлён, можно войти";a(t,"success",f),l("success",f),window.location.hash="#login"}catch(g){const f=Ie(g);a(t,"error",Fe(f)),(f==="reset_session_required"||f==="reset_session_expired"||f==="csrf_token_invalid")&&z(null)}}function De(){document.querySelectorAll('[data-form="reset-confirm"]').forEach(e=>{e.dataset.bound!=="true"&&(e.dataset.bound="true",e.addEventListener("submit",Ce))})}const Ge={google:"Google",github:"GitHub",apple:"Apple",telegram:"Telegram"};function Ue(e){var n,r,s;const t=e;return((n=t==null?void 0:t.body)==null?void 0:n.code)||((r=t==null?void 0:t.body)==null?void 0:r.error)||((s=t==null?void 0:t.body)==null?void 0:s.message)||(t==null?void 0:t.message)||"Reset request failed"}function Me(e){switch(e){case"email_not_verified":return"Email не подтверждён. Проверьте почту или пройдите регистрацию заново.";case"invalid_identifier":return"Не удалось найти пользователя с таким email.";case"turnstile_failed":return"Проверка защиты не пройдена. Обновите виджет и попробуйте ещё раз.";case"turnstile_required":return"Проверка защиты обязательна. Подтвердите Turnstile и попробуйте ещё раз.";default:return e}}function Ve(e){const t=e.querySelector('[name="type"]'),n=e.querySelector('[name="value"]')||e.querySelector('[name="email"]'),r=(n==null?void 0:n.value.trim())||"";return{type:(t==null?void 0:t.value)||"email",value:r}}async function $e(e){e.preventDefault();const t=e.currentTarget,{value:n,type:r}=Ve(t),s=R(t);if(!n){a(t,"error","Укажите email для восстановления");return}if(!s){a(t,"error",q);return}try{a(t,"pending","Отправляем ссылку...");const o=await de({type:r,value:n,turnstile_token:s});if(o.status==="oauth_only"||o.oauth_only){const u=o.provider?Ge[o.provider]??o.provider:null,g=u?`Сброс пароля недоступен. Войдите через ${u}.`:"Сброс пароля недоступен. Войдите через привязанного провайдера.";a(t,"error",o.message||g);return}const i=o.message||"Письмо со ссылкой для сброса отправлено. Ссылка действует 15 минут.";a(t,"success",i),l("info",i)}catch(o){a(t,"error",Me(Ue(o))),C(t)}}function Be(){document.querySelectorAll('[data-form="reset-request"]').forEach(e=>{e.dataset.bound!=="true"&&(e.dataset.bound="true",e.addEventListener("submit",$e))})}async function Ne(){await se()}function He(e){e&&c(e)}function Ke(){x(),c(null)}function Je(e){var n,r,s;const t=e;return((n=t==null?void 0:t.body)==null?void 0:n.code)||((r=t==null?void 0:t.body)==null?void 0:r.error)||((s=t==null?void 0:t.body)==null?void 0:s.message)||(t==null?void 0:t.message)||"Verification failed"}function w(e,t){const n=document.querySelector("[data-verify-status]");n&&(n.dataset.type=e,n.textContent=t,n.hidden=!1)}function W(){const t=new URLSearchParams(window.location.search).get("token");return t?{token:t}:null}async function je(){const e=W(),n=new URLSearchParams(window.location.search).get("type");if(!e){w("error","Нет параметров для подтверждения.");return}if(n!=="register"&&n!=="reset"){w("error","Некорректный тип подтверждения.");return}try{w("pending","Подтверждаем...");const r=await fe(e);if(n==="register"){He("user"in r?r.user??null:null),l("success","Email подтверждён, перенаправляем..."),w("success","Email подтверждён, перенаправляем..."),window.location.hash="#account";return}const s=r;if(z(s.csrf_token??null),!s.csrf_token){w("error","Ссылка для сброса устарела.");return}l("success","Подтверждено, задайте новый пароль"),w("success","Переходим к установке нового пароля"),window.location.hash="#reset"}catch(r){w("error",Je(r))}}function ze(){const e=()=>{window.location.hash.replace("#","")==="verify"&&je()};W()&&window.location.hash.replace("#","")!=="verify"&&(window.location.hash="#verify"),window.addEventListener("hashchange",e),e()}async function We(e){var i,u;e.preventDefault();const t=e.currentTarget,n=(i=b('[name="cf_account_id"]',t))==null?void 0:i.value.trim(),r=(u=b('[name="cf_bootstrap_token"]',t))==null?void 0:u.value.trim();if(!n||!r){a(t,"error","Заполните Account ID и Bootstrap Token.");return}const s=R(t);if(!s){a(t,"error",q);return}a(t,"pending","Проверяем токен..."),console.log("Stub: Cloudflare bootstrap payload",{cf_account_id:n,cf_bootstrap_token:r,turnstile_token:s}),a(t,"success","Stub: payload logged, ready to wire to /auth/integrations/cloudflare/bootstrap")}function Ye(){document.querySelectorAll('form[data-form="cf-bootstrap"]').forEach(e=>{e.dataset.bound!=="true"&&(e.dataset.bound="true",e.addEventListener("submit",We))})}const O="github_oauth_state";function Qe(e){return e.auth_url||e.url||""}async function Xe(){const e=await me(),t=Qe(e);if(e.state&&sessionStorage.setItem(O,e.state),!t)throw new Error("GitHub OAuth URL missing");window.location.href=t}async function Ze(){const e=new URL(window.location.href),t=e.searchParams.get("token"),n=e.searchParams.get("state");if(!t)return;const r=sessionStorage.getItem(O);if(r&&n&&r!==n){h("GitHub OAuth state mismatch, ignoring response");return}m(t),await I(),l("success","Signed in with GitHub"),sessionStorage.removeItem(O),window.history.replaceState({},document.title,"/account")}function et(){document.querySelectorAll('[data-social="github"]').forEach(e=>{e.dataset.bound!=="true"&&(e.dataset.bound="true",e.addEventListener("click",async t=>{t.preventDefault();try{await Xe()}catch(n){h("GitHub OAuth start failed",n),l("error","GitHub sign-in is unavailable")}}))}),Ze()}const Y="google_code_verifier",P="google_oauth_state";function tt(e){return e.auth_url||e.url||""}async function nt(){const e=await ge(),t=tt(e);if((e.code_verifier||e.verifier)&&sessionStorage.setItem(Y,e.code_verifier||e.verifier||""),e.state&&sessionStorage.setItem(P,e.state),!t)throw new Error("OAuth redirect URL is missing");window.location.href=t}async function rt(){const e=new URL(window.location.href),t=e.searchParams.get("token"),n=e.searchParams.get("state");if(!t)return;const r=sessionStorage.getItem(P);if(r&&n&&r!==n){h("OAuth state mismatch, ignoring response");return}m(t),await I(),l("success","Signed in with Google"),sessionStorage.removeItem(Y),sessionStorage.removeItem(P),window.history.replaceState({},document.title,"/account")}function st(){document.querySelectorAll('[data-social="google"]').forEach(e=>{e.dataset.bound!=="true"&&(e.dataset.bound="true",e.addEventListener("click",async t=>{t.preventDefault();try{await nt()}catch(n){h("Google OAuth start failed",n),l("error","Google sign-in is unavailable right now")}}))}),rt()}function ot(e,t,n){_("[data-onlogin]").forEach(r=>{r.hidden=!e,r.toggleAttribute("aria-hidden",!e)}),_("[data-onlogout]").forEach(r=>{r.hidden=e,r.toggleAttribute("aria-hidden",e)}),_("[data-auth-email], [data-user-email]").forEach(r=>{r.textContent=t}),_("[data-user-role]").forEach(r=>{r.textContent=n})}function at(){te(e=>{var n,r,s;const t=((n=e.user)==null?void 0:n.role)||((r=e.user)==null?void 0:r.type)||"client:owner";ot(!!(e.user&&e.token),((s=e.user)==null?void 0:s.email)??"",t)})}const it=["login","register","reset"];function ut(e){document.querySelectorAll("[data-auth-view]").forEach(t=>{const n=t.dataset.authView===e;t.toggleAttribute("hidden",!n),t.classList.toggle("is-active",n)}),document.querySelectorAll("[data-auth-tab]").forEach(t=>{const n=t.dataset.authTab===e;t.classList.toggle("active",n),t.toggleAttribute("aria-current",n)})}function D(){const e=window.location.hash.replace("#","")||"login",t=it.includes(e),n=t?"auth":e;document.querySelectorAll("section[data-route]").forEach(s=>{s.hidden=s.dataset.route!==n}),document.querySelectorAll("[data-route-link]").forEach(s=>{const o=s.dataset.routeLink;if(!o)return;const i=o===e||o==="auth"&&t;s.classList.toggle("active",i),s.toggleAttribute("aria-current",i)}),t&&ut(e)}function ct(){document.querySelectorAll('[data-action="logout"]').forEach(e=>{e.dataset.bound!=="true"&&(e.dataset.bound="true",e.addEventListener("click",async t=>{t.preventDefault(),await ye(),Ke(),l("success","Вы вышли из аккаунта"),window.location.hash="#login",D()}))})}window.addEventListener("hashchange",D);document.addEventListener("DOMContentLoaded",async()=>{at(),await Ne(),await _e(),Re(),Pe(),Be(),De(),ze(),st(),et(),Ye(),D(),ct()});
