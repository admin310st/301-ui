(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))r(n);new MutationObserver(n=>{for(const o of n)if(o.type==="childList")for(const u of o.addedNodes)u.tagName==="LINK"&&u.rel==="modulepreload"&&r(u)}).observe(document,{childList:!0,subtree:!0});function s(n){const o={};return n.integrity&&(o.integrity=n.integrity),n.referrerPolicy&&(o.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?o.credentials="include":n.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function r(n){if(n.ep)return;n.ep=!0;const o=s(n);fetch(n.href,o)}})();const K="[301-ui]";function fe(e,...t){console.info(K,e,...t)}function h(e,...t){console.debug(K,e,...t)}let Y=0;function J(e,t){try{typeof window.webstudioSetVariable=="function"&&window.webstudioSetVariable(e,t)}catch(s){console.debug("webstudio var failed",s)}}function ge(){Y+=1,J("authFetchBuster",`${Y}`),Ae().catch(e=>console.debug("buster fetch failed",e))}const he=10*60*1e3;let R=null,x=new Set,y={token:null,user:null,loading:!1,isLoggedIn:!1};function me(){x.forEach(e=>e({...y}))}function v(e){y={...y,...e},y.isLoggedIn=!!(y.token&&y.user),me()}function we(e){return x.add(e),e({...y}),()=>x.delete(e)}function j(){return y.token}function w(e){v({token:e}),ge(),J("authBearer",e?`Bearer ${e}`:""),e?pe():Q()}function V(){w(null)}function d(e){v({user:e})}async function U(){try{v({loading:!0});const e=await ee();return d(e.user??e??null),e.user??e??null}catch(e){return h("Failed to load user",e),d(null),null}finally{v({loading:!1})}}async function ye(){try{const e=await X();e.access_token&&w(e.access_token),e.user&&d(e.user??null)}catch(e){h("Refresh failed",e),V(),d(null)}}function pe(){Q(),j()&&(R=setTimeout(ye,he))}function Q(){R&&clearTimeout(R),R=null}async function be(){try{v({loading:!0});const e=await X();if(e&&e.access_token){const t=e.access_token;w(t??null);const s=await ee();d(s.user??s??null)}else w(null),d(null)}catch(e){h("Auth init failed",e),w(null),d(null)}finally{v({loading:!1}),fe("Auth state initialized")}}function ve(e,t,s="Request failed"){const r=typeof t=="object"&&t&&"message"in t?String(t.message):s,n=new Error(r);return n.status=e,n.body=t,n}async function ke(e){try{return await e.json()}catch(t){return console.debug("Failed to parse JSON",t),null}}const Se="https://api.301.st/auth";async function f(e,t={}){const s=new Headers(t.headers??{}),r=j();r&&!s.has("authorization")&&s.set("authorization",`Bearer ${r}`),t.body&&!(t.body instanceof FormData)&&s.set("content-type","application/json");const n=await fetch(`${Se}${e}`,{credentials:"include",...t,headers:s}),o=await ke(n);if(!n.ok)throw ve(n.status,o,n.statusText);return o??{}}async function Ae(){try{await f("/me")}catch(e){h("Auth fetch buster failed",e)}}async function Te(e){const t=await f("/login",{method:"POST",body:JSON.stringify(e)});return t.access_token&&w(t.access_token),t.user&&d(t.user),t}async function X(){return f("/refresh",{method:"POST"})}async function _e(e){return await f("/register",{method:"POST",body:JSON.stringify(e)})}async function Le(e){return f("/reset_password",{method:"POST",body:JSON.stringify(e)})}async function Z(e){const t=await f("/verify",{method:"POST",body:JSON.stringify(e)});return"access_token"in t&&t.access_token&&w(t.access_token),"user"in t&&t.user&&d(t.user),t}async function Re(e){return f("/confirm_password",{method:"POST",body:JSON.stringify(e)})}async function qe(){return f("/oauth/google/start")}async function Pe(){return f("/oauth/github/start")}async function Ee(){try{await f("/logout",{method:"POST"})}catch(e){console.debug("Logout request failed",e)}V(),d(null)}async function ee(){return f("/me")}const Ce={common:{pleaseWait:"Please wait..."},layout:{nav:{login:"Login",register:"Register",reset:"Forgot password?",logout:"Log out",aria:"Authentication navigation"},headerTabsLabel:"Authentication actions",footer:{description:"Redirects and analytics."},langSwitcher:{label:"Switch language",en:"EN",ru:"RU"}},auth:{hero:{eyebrow:"Production login",title:"Access 301.st",subtitle:"Use email and password to access your account or request a reset."},login:{title:"Sign in to 301.st",subtitle:"Production auth flow with Turnstile and Omni token.",emailLabel:"Email",passwordLabel:"Password",submit:"Sign in",submitAria:"Sign in to 301.st",linkToRegister:"Create account",linkToReset:"Forgot password?",statusDefault:"Enter your email and password to sign in.",statusMissing:"Enter email and password",statusPending:"Signing in...",statusSuccess:"You are signed in to 301.st",errors:{invalidLogin:"Invalid login or password. Try again or request a reset.",userAlreadyRegistered:"This email is already registered. Try signing in or resetting password.",passwordTooWeak:"Password is too weak. Use upper & lower case letters plus digits.",turnstileFailed:"Turnstile check failed. Refresh the widget and try again.",turnstileRequired:"Turnstile is required. Complete the check and try again.",fallback:"Sign-in failed"},avatarPlaceholder:"Enter email"},register:{title:"Create your 301.st account",submit:"Create account",submitAria:"Create your 301.st account",statusDefault:"You’ll receive a verification email (OmniFlow).",passwordHint:"Must contain upper & lower case letters and at least one digit.",statusMissing:"Email and password are required",statusPending:"Creating account...",statusSuccess:"We sent a verification email to {{email}}. Follow the link to finish registration.",errors:{invalidLogin:"Invalid login or password. Try again or request a reset.",userAlreadyRegistered:"This email is already registered. Try signing in or resetting password.",passwordTooWeak:"Password is too weak. Use upper & lower case letters plus digits.",turnstileFailed:"Turnstile check failed. Refresh the widget and try again.",turnstileRequired:"Turnstile is required. Complete the check and try again.",fallback:"Registration failed"}},reset:{title:"Reset password",requestButton:"Request reset link",requestAria:"Request password reset link",statusDefault:"We’ll send you a link to set a new password.",linkToLogin:"Back to login",statusMissing:"Enter an email to reset",statusPending:"Sending link...",statusSent:"Reset link sent. It is valid for 15 minutes.",oauthOnly:"Password reset is unavailable. Sign in via your linked provider.",oauthOnlyProvider:"Password reset is unavailable. Sign in via {{provider}}.",errors:{emailNotVerified:"Email is not verified. Check your inbox or register again.",invalidIdentifier:"No user found for this email.",turnstileFailed:"Turnstile check failed. Refresh the widget and try again.",turnstileRequired:"Turnstile is required. Complete the check and try again.",fallback:"Reset request failed"}},resetConfirm:{eyebrow:"New password",title:"Set a password",passwordLabel:"New password",confirmLabel:"Confirm password",submit:"Update password",submitAria:"Update password and continue",statusDefault:"Make sure passwords match and are strong enough.",linkToLogin:"Sign in",statusMissing:"Enter a new password",statusPending:"Updating password...",statusMismatch:"Passwords do not match",statusSuccess:"Password updated. You can now sign in.",errors:{sessionRequired:"Reset session not found. Request a new password reset.",sessionExpired:"Reset link has expired. Request a new reset.",csrfInvalid:"Reset session is invalid. Request a new link.",passwordReused:"New password must differ from the previous one.",passwordTooWeak:"Password is too weak. Use upper & lower case letters plus digits.",expiredLink:"Reset link expired. Request a new one.",fallback:"Password update failed"}},verify:{eyebrow:"Verification",title:"Verifying…",subtitle:"We are validating the link from your email. This takes a few seconds.",missingParams:"No verification parameters found.",pending:"Verifying...",success:"Email verified, redirecting...",error:"Verification failed"},resetVerify:{eyebrow:"Verification",title:"Verifying reset…",subtitle:"We are checking the reset link from your email. This will only take a moment.",invalidLink:"The reset link is invalid or expired.",pending:"Confirming reset link...",proceed:"Moving to password creation",successFallback:"Password updated. You can now sign in."},session:{active:"Session is active.",signedInAs:"You are signed in as <strong data-auth-email data-user-email></strong>. Current role: <span data-user-role>client:owner</span>.",logout:"Log out",notAuthenticated:"You are not authenticated yet."},messages:{notAuthenticated:"You are not authenticated yet.",authenticatedAs:"You are signed in as",logout:"Log out",logoutSuccess:"You have been signed out",turnstileRequired:"Please complete the Turnstile check."},links:{toLogin:"Back to login",toRegister:"Create account"},turnstile:{hint:"Turnstile protects login, registration, reset and Cloudflare bootstrap from bots."},password:{minLength:"Password must be at least 8 characters long.",requirements:"Password must include upper & lower case letters and at least one digit."}},cf:{wizard:{title:"Cloudflare account bootstrap",subtitle:"Step 1 · Paste your Account ID and Bootstrap API token.",accountIdLabel:"Cloudflare Account ID",tokenLabel:"Bootstrap API token",tokenHint:"Created as '301st Bootstrap' with 'Account API Tokens: Edit' permission.",accountIdPlaceholder:"e.g. 1234567890abcdef1234567890abcdef",tokenPlaceholder:"Paste token with 'Account API Tokens: Edit' scope…",avatarMeta:"Orange actions below are reserved for Cloudflare-level changes.",submit:"Save & verify token",submitAria:"Save and verify Cloudflare token",statusStub:"This will hit /auth/integrations/cloudflare/bootstrap once wired.",statusMissing:"Fill Account ID and Bootstrap Token.",statusPending:"Validating token...",statusLogged:"Stub: payload logged, ready to wire to /auth/integrations/cloudflare/bootstrap"}},notice:{errors:{resetInvalid:"The reset link is invalid or expired."},success:{resetDone:"Password updated. You can now sign in."}}},Ie={common:{pleaseWait:"Пожалуйста, подождите..."},layout:{nav:{login:"Вход",register:"Регистрация",reset:"Забыли пароль?",logout:"Выйти",aria:"Навигация по аутентификации"},headerTabsLabel:"Тип операции",footer:{description:"Редиректы и аналитика."},langSwitcher:{label:"Переключить язык",en:"EN",ru:"RU"}},auth:{hero:{eyebrow:"Боевой вход",title:"Доступ к 301.st",subtitle:"Используйте email и пароль или запросите восстановление."},login:{title:"Вход в 301.st",subtitle:"Боевой поток авторизации с Turnstile и Omni токеном.",emailLabel:"Email",passwordLabel:"Пароль",submit:"Войти",submitAria:"Войти в 301.st",linkToRegister:"Создать аккаунт",linkToReset:"Забыли пароль?",statusDefault:"Введите email и пароль, чтобы войти в аккаунт.",statusMissing:"Введите email и пароль",statusPending:"Входим...",statusSuccess:"Вы вошли в 301.st",errors:{invalidLogin:"Неправильный логин или пароль. Попробуйте ещё раз или запросите восстановление доступа.",userAlreadyRegistered:"Такой email уже зарегистрирован. Попробуйте войти или восстановить пароль.",passwordTooWeak:"Пароль слишком слабый. Минимум 8 символов, буквы в разных регистрах и цифры.",turnstileFailed:"Проверка защиты не пройдена. Обновите виджет и попробуйте ещё раз.",turnstileRequired:"Проверка защиты обязательна. Подтвердите Turnstile и попробуйте ещё раз.",fallback:"Ошибка входа"},avatarPlaceholder:"Укажите email"},register:{title:"Создание аккаунта 301.st",submit:"Создать аккаунт",submitAria:"Создать аккаунт 301.st",statusDefault:"Вы получите письмо для подтверждения (OmniFlow).",passwordHint:"Пароль должен содержать заглавные и строчные буквы и хотя бы одну цифру.",statusMissing:"Нужны email и пароль",statusPending:"Создаём аккаунт...",statusSuccess:"Мы отправили письмо на {{email}}. Перейдите по ссылке, чтобы завершить регистрацию.",errors:{invalidLogin:"Неправильный логин или пароль. Попробуйте ещё раз или запросите восстановление доступа.",userAlreadyRegistered:"Такой email уже зарегистрирован. Попробуйте войти или восстановить пароль.",passwordTooWeak:"Пароль слишком слабый. Минимум 8 символов, буквы в разных регистрах и цифры.",turnstileFailed:"Проверка защиты не пройдена. Обновите виджет и попробуйте ещё раз.",turnstileRequired:"Проверка защиты обязательна. Подтвердите Turnstile и попробуйте ещё раз.",fallback:"Ошибка регистрации"}},reset:{title:"Восстановление пароля",requestButton:"Отправить ссылку для восстановления",requestAria:"Запросить ссылку для восстановления пароля",statusDefault:"Мы отправим ссылку для установки нового пароля.",linkToLogin:"Вернуться к входу",statusMissing:"Укажите email для восстановления",statusPending:"Отправляем ссылку...",statusSent:"Письмо со ссылкой для сброса отправлено. Ссылка действует 15 минут.",oauthOnly:"Сброс пароля недоступен. Войдите через привязанного провайдера.",oauthOnlyProvider:"Сброс пароля недоступен. Войдите через {{provider}}.",errors:{emailNotVerified:"Email не подтверждён. Проверьте почту или пройдите регистрацию заново.",invalidIdentifier:"Не удалось найти пользователя с таким email.",turnstileFailed:"Проверка защиты не пройдена. Обновите виджет и попробуйте ещё раз.",turnstileRequired:"Проверка защиты обязательна. Подтвердите Turnstile и попробуйте ещё раз.",fallback:"Ошибка запроса сброса пароля"}},resetConfirm:{eyebrow:"Новый пароль",title:"Установить пароль",passwordLabel:"Новый пароль",confirmLabel:"Повторите пароль",submit:"Обновить пароль",submitAria:"Обновить пароль и продолжить",statusDefault:"Убедитесь, что пароли совпадают и достаточно надёжны.",linkToLogin:"Войти",statusMissing:"Введите новый пароль",statusPending:"Обновляем пароль...",statusMismatch:"Пароли не совпадают",statusSuccess:"Пароль обновлён. Теперь вы можете войти.",errors:{sessionRequired:"Сессия сброса не найдена. Запросите сброс пароля ещё раз.",sessionExpired:"Ссылка для сброса устарела. Запросите новый сброс пароля.",csrfInvalid:"Сессия сброса некорректна. Запросите новую ссылку.",passwordReused:"Новый пароль не должен совпадать с предыдущим.",passwordTooWeak:"Пароль слишком слабый. Минимум 8 символов, буквы в разных регистрах и цифры.",expiredLink:"Ссылка для сброса просрочена. Запросите новую.",fallback:"Не удалось обновить пароль"}},verify:{eyebrow:"Подтверждение",title:"Подтверждаем…",subtitle:"Проверяем ссылку из письма. Это займёт пару секунд.",missingParams:"Нет параметров для подтверждения.",pending:"Подтверждаем...",success:"Email подтверждён, перенаправляем...",error:"Ошибка подтверждения"},resetVerify:{eyebrow:"Подтверждение",title:"Подтверждаем восстановление…",subtitle:"Проверяем ссылку из письма. Это займёт пару секунд.",invalidLink:"Ссылка восстановления недействительна или устарела.",pending:"Подтверждаем ссылку для сброса...",proceed:"Переходим к установке нового пароля",successFallback:"Пароль обновлён. Теперь вы можете войти."},session:{active:"Сессия активна.",signedInAs:"Вы вошли как <strong data-auth-email data-user-email></strong>. Текущая роль: <span data-user-role>client:owner</span>.",logout:"Выйти",notAuthenticated:"Вы ещё не авторизованы."},messages:{notAuthenticated:"Вы ещё не авторизованы.",authenticatedAs:"Вы вошли как",logout:"Выйти",logoutSuccess:"Вы вышли из аккаунта",turnstileRequired:"Пройдите проверку защиты (Turnstile)."},links:{toLogin:"Вернуться к входу",toRegister:"Создать аккаунт"},turnstile:{hint:"Turnstile защищает вход, регистрацию, восстановление и Cloudflare bootstrap от ботов."},password:{minLength:"Пароль должен быть не короче 8 символов.",requirements:"Пароль должен содержать буквы в разных регистрах и хотя бы одну цифру."}},cf:{wizard:{title:"Привязка аккаунта Cloudflare",subtitle:"Шаг 1 · Вставьте Account ID и Bootstrap API токен, как описано в Integrations.",accountIdLabel:"Cloudflare Account ID",tokenLabel:"Bootstrap API токен",tokenHint:"Создайте токен с названием '301st Bootstrap' и правами 'Account API Tokens: Edit'.",accountIdPlaceholder:"например, 1234567890abcdef1234567890abcdef",tokenPlaceholder:"Вставьте токен с правами 'Account API Tokens: Edit'…",avatarMeta:"Оранжевые действия ниже отвечают за настройки уровня Cloudflare.",submit:"Сохранить и проверить токен",submitAria:"Сохранить и проверить токен Cloudflare",statusStub:"Позже эта форма будет отправлять данные в /auth/integrations/cloudflare/bootstrap.",statusMissing:"Заполните Account ID и Bootstrap Token.",statusPending:"Проверяем токен...",statusLogged:"Заглушка: payload залогирован, готово к отправке на /auth/integrations/cloudflare/bootstrap"}},notice:{errors:{resetInvalid:"Ссылка восстановления недействительна или устарела."},success:{resetDone:"Пароль обновлён. Теперь вы можете войти."}}},$={en:Ce,ru:Ie};let p="en";function Oe(){var t,s,r;if(typeof navigator>"u")return"en";const e=((t=navigator.language)==null?void 0:t.toLowerCase())||((r=(s=navigator.languages)==null?void 0:s[0])==null?void 0:r.toLowerCase());return e!=null&&e.startsWith("ru")?"ru":"en"}function xe(e){var t;p=$[e]?e:"en",typeof window<"u"&&(window.localStorage.setItem("locale",p),(t=window.document)!=null&&t.documentElement&&(window.document.documentElement.lang=p))}function B(){var t;if(typeof window>"u")return p;const e=window.localStorage.getItem("locale");return e&&$[e]?p=e:p=Oe(),(t=window.document)!=null&&t.documentElement&&(window.document.documentElement.lang=p),p}function a(e){const t=B(),s=$[t];return e.split(".").reduce((r,n)=>r&&r[n]!=null?r[n]:null,s)??e}function te(e,t){let s=a(e);return Object.entries(t).forEach(([r,n])=>{s=s.replace(new RegExp(`{{${r}}}`,"g"),n)}),s}function O(){return a("auth.messages.turnstileRequired")}const q="0x4AAAAAACB-_l9VwF1M_QHU",F=new WeakMap;let se=q,k=null,C=null,G=0;const Fe=2*60*1e3;async function Me(){try{const e=await fetch("/env",{cache:"no-store"});if(!e.ok)return q;const t=await e.json();return t.turnstileSitekey||t.turnstile_sitekey||q}catch(e){return h("Failed to load Turnstile sitekey",e),q}}function De(){return typeof window>"u"?Promise.resolve(null):window.turnstile?Promise.resolve(window.turnstile):new Promise(e=>{if(!document.querySelector("script[data-turnstile]")){const r=document.createElement("script");r.src="https://challenges.cloudflare.com/turnstile/v0/api.js?render=explicit",r.async=!0,r.defer=!0,r.dataset.turnstile="true",document.head.appendChild(r)}const s=()=>e(window.turnstile||null);window.addEventListener("turnstileLoaded",s,{once:!0}),setTimeout(s,2e3)})}function Ne(e){e instanceof Document&&(k==null||k.disconnect(),k=new MutationObserver(()=>re(e)),k.observe(e,{childList:!0,subtree:!0}))}async function Ve(e=document){se=await Me(),await De()&&(re(e),Ne(e))}function P(e,t){if(e){F.set(e,t);const s=e.querySelector('input[name="turnstile_token"]');s&&(s.value=t??"");return}C=t,G=t?Date.now():0}function re(e=document){const t=window.turnstile;!t||typeof t.render!="function"||(e.querySelectorAll(".turnstile-widget").forEach(s=>{if(s.dataset.tsRendered==="1")return;s.dataset.tsRendered="1";const r=s.closest("form"),n=t.render(s,{sitekey:se,callback:o=>{P(r,o);const u=r==null?void 0:r.querySelector('button[type="submit"]');u&&(u.disabled=!1)},"expired-callback":()=>{P(r,null)},"error-callback":()=>{P(r,null);const o=r==null?void 0:r.querySelector('button[type="submit"]');o&&(o.disabled=!0)}});typeof n=="string"&&(s.dataset.widgetId=n)}),e.querySelectorAll('form[data-form="login"], form[data-form="register"], form[data-form="reset-request"], form[data-form="reset-confirm"], form[data-form="cf-bootstrap"]').forEach(s=>{if(!s.querySelector('input[name="turnstile_token"]')){const r=document.createElement("input");r.type="hidden",r.name="turnstile_token",s.appendChild(r)}}))}function T(e){var s;return e&&F.has(e)?F.get(e)??null:C&&Date.now()-G<Fe?C:e&&((s=e.querySelector('input[name="turnstile_token"]'))==null?void 0:s.value)||null}function W(e){const t=window.turnstile;if(!(!t||typeof t.reset!="function")){if(C=null,G=0,e){const s=e.querySelector(".turnstile-widget");if(s!=null&&s.dataset.widgetId){t.reset(s.dataset.widgetId),P(e,null);return}}try{t.reset()}catch(s){h("Turnstile reset failed",s)}}}const A=(e,t=document)=>t.querySelector(e),_=(e,t=document)=>Array.from(t.querySelectorAll(e));function i(e,t,s){e.dataset.state=t;const r=A("[data-form-status], [data-status]",e);r&&(r.hidden=!1,r.dataset.type=t,s!==void 0&&(r.textContent=s));const n=e.querySelector('button[type="submit"]');n&&(n.dataset.labelReady||(n.dataset.labelReady=n.textContent??""),n.disabled=t==="pending",n.textContent=t==="pending"?n.dataset.labelLoading||a("common.pleaseWait"):n.dataset.labelReady)}const Ue="#GlobalNotice",$e="#GlobalNoticeText",z="auth_notice",Be=8e3;function ne(){const e=document.querySelector(Ue),t=document.querySelector($e);return{root:e,text:t}}function b(e,t){const{root:s,text:r}=ne();!s||!r||(s.dataset.notice="visible",s.dataset.type=e,r.textContent=t)}function ae(){const{root:e,text:t}=ne();!e||!t||(e.dataset.notice="hidden",delete e.dataset.type,t.textContent="")}function Ge(){const e=sessionStorage.getItem(z);if(!e)return null;sessionStorage.removeItem(z);try{return JSON.parse(e)}catch(t){return console.debug("Failed to parse persisted notice",t),null}}function We(e){const t=e.get("status"),s=e.get("msg");if(!t&&!s)return null;let r;switch(t){case"success":r="success";break;case"error":case"fail":r="error";break;default:r="info"}return{type:r,message:s||"",autoHide:!0}}function He(e){e.delete("status"),e.delete("msg");const t=e.toString(),s=window.location.hash,r=window.location.pathname,n=t?`${r}?${t}${s}`:`${r}${s}`;window.history.replaceState({},document.title,n)}function Ye(){const e=new URLSearchParams(window.location.search),t=We(e),s=Ge(),r=t||s;r&&(b(r.type,r.message),r.autoHide!==!1&&window.setTimeout(()=>{ae()},Be),t&&He(e))}function m(e,t){b(e,t)}function ze(){ae()}function Ke(e){var s,r,n;const t=e;return((s=t==null?void 0:t.body)==null?void 0:s.code)||((r=t==null?void 0:t.body)==null?void 0:r.error)||((n=t==null?void 0:t.body)==null?void 0:n.message)||(t==null?void 0:t.message)||a("auth.login.errors.fallback")}function Je(e){switch(e){case"invalid_login":return a("auth.login.errors.invalidLogin");case"user_already_registered":return a("auth.login.errors.userAlreadyRegistered");case"password_too_weak":return a("auth.login.errors.passwordTooWeak");case"turnstile_failed":return a("auth.login.errors.turnstileFailed");case"turnstile_required":return a("auth.login.errors.turnstileRequired");default:return e||a("auth.login.errors.fallback")}}function je(e){const t=e.querySelector("[data-avatar-source]"),s=A("[data-avatar-label]"),r=A("[data-avatar-img]");if(!t)return;const n=o=>{const u=o.trim();s&&(s.textContent=u||a("auth.login.avatarPlaceholder")),r&&(r.src="/img/anonymous-avatar.svg")};n(t.value||""),t.addEventListener("input",o=>n(o.target.value))}async function Qe(e){var o,u;e.preventDefault();const t=e.currentTarget;ze();const s=(o=t.querySelector('[name="email"]'))==null?void 0:o.value.trim(),r=((u=t.querySelector('[name="password"]'))==null?void 0:u.value)||"",n=T(t);if(!s||!r){i(t,"error",a("auth.login.statusMissing"));return}if(!n){i(t,"error",O());return}try{i(t,"pending",a("auth.login.statusPending"));const c=await Te({email:s,password:r,turnstile_token:n||void 0});await U();const l=c.message||a("auth.login.statusSuccess");i(t,"success",l),m("success",l),t.reset(),window.location.hash="#login"}catch(c){const l=Je(Ke(c));i(t,"error",l),W(t)}}function Xe(){document.querySelectorAll('[data-form="login"]').forEach(e=>{e.dataset.bound!=="true"&&(e.dataset.bound="true",e.addEventListener("submit",Qe),je(e))})}function oe(e){if(!e||e.length<8)return a("auth.password.minLength");const t=/[a-z]/.test(e),s=/[A-Z]/.test(e),r=/\d/.test(e);return!t||!s||!r?a("auth.password.requirements"):null}function Ze(e){var s,r,n;const t=e;return((s=t==null?void 0:t.body)==null?void 0:s.code)||((r=t==null?void 0:t.body)==null?void 0:r.error)||((n=t==null?void 0:t.body)==null?void 0:n.message)||(t==null?void 0:t.message)||a("auth.register.errors.fallback")}function et(e){switch(e){case"invalid_login":return a("auth.register.errors.invalidLogin");case"user_already_registered":return a("auth.register.errors.userAlreadyRegistered");case"password_too_weak":return a("auth.register.errors.passwordTooWeak");case"turnstile_failed":return a("auth.register.errors.turnstileFailed");case"turnstile_required":return a("auth.register.errors.turnstileRequired");default:return e||a("auth.register.errors.fallback")}}async function tt(e){var u,c;e.preventDefault();const t=e.currentTarget,s=(u=t.querySelector('[name="email"]'))==null?void 0:u.value.trim(),r=((c=t.querySelector('[name="password"]'))==null?void 0:c.value)||"",n=T(t);if(!s||!r){i(t,"error",a("auth.register.statusMissing"));return}const o=oe(r);if(o){i(t,"error",o);return}if(!n){i(t,"error",O());return}try{i(t,"pending",a("auth.register.statusPending"));const g=(await _e({email:s,password:r,turnstile_token:n||void 0})).message||te("auth.register.statusSuccess",{email:s});i(t,"success",g),m("info",g)}catch(l){i(t,"error",et(Ze(l))),W(t)}}function st(){document.querySelectorAll('[data-form="register"]').forEach(e=>{e.dataset.bound!=="true"&&(e.dataset.bound="true",e.addEventListener("submit",tt))})}let ie=null;function M(e){ie=e}function rt(){return ie}function nt(e){var s,r,n;const t=e;return((s=t==null?void 0:t.body)==null?void 0:s.code)||((r=t==null?void 0:t.body)==null?void 0:r.error)||((n=t==null?void 0:t.body)==null?void 0:n.message)||(t==null?void 0:t.message)||a("auth.resetConfirm.errors.fallback")}function at(e){switch(e){case"reset_session_required":return a("auth.resetConfirm.errors.sessionRequired");case"reset_session_expired":return a("auth.resetConfirm.errors.sessionExpired");case"csrf_token_invalid":return a("auth.resetConfirm.errors.csrfInvalid");case"password_reused":return a("auth.resetConfirm.errors.passwordReused");case"password_too_weak":return a("auth.resetConfirm.errors.passwordTooWeak");default:return e||a("auth.resetConfirm.errors.fallback")}}async function ot(e){var u,c;e.preventDefault();const t=e.currentTarget,s=((u=t.querySelector('[name="password"]'))==null?void 0:u.value)||"",r=((c=t.querySelector('[name="password_confirm"]'))==null?void 0:c.value)||"",n=rt();if(!n){i(t,"error",a("auth.resetConfirm.errors.expiredLink"));return}if(!s||!r){i(t,"error",a("auth.resetConfirm.statusMissing"));return}const o=oe(s);if(o){i(t,"error",o);return}if(s!==r){i(t,"error",a("auth.resetConfirm.statusMismatch"));return}try{i(t,"pending",a("auth.resetConfirm.statusPending"));const g=(await Re({password:s,csrf_token:n})).message||a("auth.resetConfirm.statusSuccess");i(t,"success",g),m("success",g),window.location.hash="#login"}catch(l){const g=nt(l);i(t,"error",at(g)),(g==="reset_session_required"||g==="reset_session_expired"||g==="csrf_token_invalid")&&M(null)}}function it(){document.querySelectorAll('[data-form="reset-confirm"]').forEach(e=>{e.dataset.bound!=="true"&&(e.dataset.bound="true",e.addEventListener("submit",ot))})}const ut={google:"Google",github:"GitHub",apple:"Apple",telegram:"Telegram"};function ct(e){var s,r,n;const t=e;return((s=t==null?void 0:t.body)==null?void 0:s.code)||((r=t==null?void 0:t.body)==null?void 0:r.error)||((n=t==null?void 0:t.body)==null?void 0:n.message)||(t==null?void 0:t.message)||a("auth.reset.errors.fallback")}function lt(e){switch(e){case"email_not_verified":return a("auth.reset.errors.emailNotVerified");case"invalid_identifier":return a("auth.reset.errors.invalidIdentifier");case"turnstile_failed":return a("auth.reset.errors.turnstileFailed");case"turnstile_required":return a("auth.reset.errors.turnstileRequired");default:return e||a("auth.reset.errors.fallback")}}function dt(e){const t=e.querySelector('[name="type"]'),s=e.querySelector('[name="value"]')||e.querySelector('[name="email"]'),r=(s==null?void 0:s.value.trim())||"";return{type:(t==null?void 0:t.value)||"email",value:r}}async function ft(e){e.preventDefault();const t=e.currentTarget,{value:s,type:r}=dt(t),n=T(t);if(!s){i(t,"error",a("auth.reset.statusMissing"));return}if(!n){i(t,"error",O());return}try{i(t,"pending",a("auth.reset.statusPending"));const o=await Le({type:r,value:s,turnstile_token:n});if(o.status==="oauth_only"||o.oauth_only){const c=o.provider?ut[o.provider]??o.provider:null,l=c?te("auth.reset.oauthOnlyProvider",{provider:c}):a("auth.reset.oauthOnly");i(t,"error",o.message||l);return}const u=o.message||a("auth.reset.statusSent");i(t,"success",u),m("info",u)}catch(o){i(t,"error",lt(ct(o))),W(t)}}function gt(){document.querySelectorAll('[data-form="reset-request"]').forEach(e=>{e.dataset.bound!=="true"&&(e.dataset.bound="true",e.addEventListener("submit",ft))})}const I=()=>a("auth.resetVerify.invalidLink");function S(e,t){const s=document.querySelector("[data-verify-status]");s&&(s.dataset.type=e,s.textContent=t,s.hidden=!1)}function ht(){const e=new URLSearchParams(window.location.search),t=e.get("token"),s=e.get("type");return{token:t,type:s}}function E(e){const t=window.location.pathname.startsWith("/auth")?"/auth/":"/",s=e?`#${e.replace("#","")}`:"";window.history.replaceState({},document.title,`${t}${s}`)}function mt(e){var s,r,n;const t=e;return((s=t==null?void 0:t.body)==null?void 0:s.code)||((r=t==null?void 0:t.body)==null?void 0:r.error)||((n=t==null?void 0:t.body)==null?void 0:n.message)||(t==null?void 0:t.message)||I()}function wt(e){switch(e){case"reset_session_expired":case"reset_session_required":case"token_invalid":case"token_expired":return I();default:return e||I()}}async function yt(e){S("pending",a("auth.resetVerify.pending"));const t=T();try{const s=await Z({...e,turnstile_token:t??void 0}),r=s.message||a("notice.success.resetDone");if(s.csrf_token){M(s.csrf_token),b("success",r),S("success",a("auth.resetVerify.proceed")),E("reset"),window.location.hash="#reset";return}const n=a("auth.resetVerify.successFallback");b("success",r||n),S("success",r||n),E("login"),window.location.hash="#login"}catch(s){const r=wt(mt(s));M(null),b("error",r),S("error",r),E("login")}}function pt(){const e=ht();if(e.type==="reset"){if(window.location.hash="#verify",!e.token){const t=I();b("error",t),S("error",t),E("login");return}yt({token:e.token})}}async function bt(){await be()}function vt(e){e&&d(e)}function kt(){V(),d(null)}function St(e){var s,r,n;const t=e;return((s=t==null?void 0:t.body)==null?void 0:s.code)||((r=t==null?void 0:t.body)==null?void 0:r.error)||((n=t==null?void 0:t.body)==null?void 0:n.message)||(t==null?void 0:t.message)||a("auth.verify.error")}function L(e,t){const s=document.querySelector("[data-verify-status]");s&&(s.dataset.type=e,s.textContent=t,s.hidden=!1)}function ue(){const e=new URLSearchParams(window.location.search),t=e.get("token"),s=e.get("type");return!t||s!=="register"?null:{token:t}}async function At(){const e=ue();if(!e){L("error",a("auth.verify.missingParams"));return}try{L("pending",a("auth.verify.pending"));const t=await Z(e);vt("user"in t?t.user??null:null);const s=a("auth.verify.success");m("success",s),L("success",s),window.location.hash="#account"}catch(t){L("error",St(t))}}function Tt(){const e=()=>{window.location.hash.replace("#","")==="verify"&&At()};ue()&&window.location.hash.replace("#","")!=="verify"&&(window.location.hash="#verify"),window.addEventListener("hashchange",e),e()}async function _t(e){var u,c;e.preventDefault();const t=e.currentTarget,s=(u=A('[name="cf_account_id"]',t))==null?void 0:u.value.trim(),r=(c=A('[name="cf_bootstrap_token"]',t))==null?void 0:c.value.trim();if(!s||!r){i(t,"error",a("cf.wizard.statusMissing"));return}const n=T(t);if(!n){i(t,"error",O());return}i(t,"pending",a("cf.wizard.statusPending")),console.log("Stub: Cloudflare bootstrap payload",{cf_account_id:s,cf_bootstrap_token:r,turnstile_token:n}),i(t,"success",a("cf.wizard.statusLogged"))}function Lt(){document.querySelectorAll('form[data-form="cf-bootstrap"]').forEach(e=>{e.dataset.bound!=="true"&&(e.dataset.bound="true",e.addEventListener("submit",_t))})}const D="github_oauth_state";function Rt(e){return e.auth_url||e.url||""}async function qt(){const e=await Pe(),t=Rt(e);if(e.state&&sessionStorage.setItem(D,e.state),!t)throw new Error("GitHub OAuth URL missing");window.location.href=t}async function Pt(){const e=new URL(window.location.href),t=e.searchParams.get("token"),s=e.searchParams.get("state");if(!t)return;const r=sessionStorage.getItem(D);if(r&&s&&r!==s){h("GitHub OAuth state mismatch, ignoring response");return}w(t),await U(),m("success","Signed in with GitHub"),sessionStorage.removeItem(D),window.history.replaceState({},document.title,"/account")}function Et(){document.querySelectorAll('[data-social="github"]').forEach(e=>{e.dataset.bound!=="true"&&(e.dataset.bound="true",e.addEventListener("click",async t=>{t.preventDefault();try{await qt()}catch(s){h("GitHub OAuth start failed",s),m("error","GitHub sign-in is unavailable")}}))}),Pt()}const ce="google_code_verifier",N="google_oauth_state";function Ct(e){return e.auth_url||e.url||""}async function It(){const e=await qe(),t=Ct(e);if((e.code_verifier||e.verifier)&&sessionStorage.setItem(ce,e.code_verifier||e.verifier||""),e.state&&sessionStorage.setItem(N,e.state),!t)throw new Error("OAuth redirect URL is missing");window.location.href=t}async function Ot(){const e=new URL(window.location.href),t=e.searchParams.get("token"),s=e.searchParams.get("state");if(!t)return;const r=sessionStorage.getItem(N);if(r&&s&&r!==s){h("OAuth state mismatch, ignoring response");return}w(t),await U(),m("success","Signed in with Google"),sessionStorage.removeItem(ce),sessionStorage.removeItem(N),window.history.replaceState({},document.title,"/account")}function xt(){document.querySelectorAll('[data-social="google"]').forEach(e=>{e.dataset.bound!=="true"&&(e.dataset.bound="true",e.addEventListener("click",async t=>{t.preventDefault();try{await It()}catch(s){h("Google OAuth start failed",s),m("error","Google sign-in is unavailable right now")}}))}),Ot()}function Ft(e,t,s){_("[data-onlogin]").forEach(r=>{r.hidden=!e,r.toggleAttribute("aria-hidden",!e)}),_("[data-onlogout]").forEach(r=>{r.hidden=e,r.toggleAttribute("aria-hidden",e)}),_("[data-auth-email], [data-user-email]").forEach(r=>{r.textContent=t}),_("[data-user-role]").forEach(r=>{r.textContent=s})}function Mt(){we(e=>{var s,r,n;const t=((s=e.user)==null?void 0:s.role)||((r=e.user)==null?void 0:r.type)||"client:owner";Ft(!!(e.user&&e.token),((n=e.user)==null?void 0:n.email)??"",t)})}function le(){if(typeof document>"u")return;const e=B();document.documentElement.lang=e,document.documentElement.dataset.locale=e}function de(e=document){le(),e.querySelectorAll("[data-i18n-html]").forEach(t=>{const s=t.dataset.i18nHtml;s&&(t.innerHTML=a(s))}),e.querySelectorAll("[data-i18n]").forEach(t=>{const s=t.dataset.i18n;s&&(t.textContent=a(s))}),e.querySelectorAll("[data-i18n-aria]").forEach(t=>{const s=t.dataset.i18nAria;s&&t.setAttribute("aria-label",a(s))}),e.querySelectorAll("[data-i18n-placeholder]").forEach(t=>{const s=t.dataset.i18nPlaceholder;s&&t.setAttribute("placeholder",a(s))})}function Dt(e=document){const t=B();e.querySelectorAll("[data-lang]").forEach(s=>{const r=s.dataset.lang;s.classList.toggle("is-active",r===t),s.setAttribute("aria-pressed",String(r===t)),s.addEventListener("click",()=>{xe(r),le(),e.querySelectorAll("[data-lang]").forEach(n=>n.classList.toggle("is-active",n.dataset.lang===r)),e.querySelectorAll("[data-lang]").forEach(n=>n.setAttribute("aria-pressed",String(n.dataset.lang===r))),de(document)})})}const Nt=["login","register","reset"];function Vt(e){document.querySelectorAll("[data-auth-view]").forEach(t=>{const s=t.dataset.authView===e;t.toggleAttribute("hidden",!s),t.classList.toggle("is-active",s)}),document.querySelectorAll("[data-auth-tab]").forEach(t=>{const s=t.dataset.authTab===e;t.classList.toggle("active",s),t.toggleAttribute("aria-current",s)})}function H(){const e=window.location.hash.replace("#","")||"login",t=Nt.includes(e),s=t?"auth":e;document.querySelectorAll("section[data-route]").forEach(n=>{n.hidden=n.dataset.route!==s}),document.querySelectorAll("[data-route-link]").forEach(n=>{const o=n.dataset.routeLink;if(!o)return;const u=o===e||o==="auth"&&t;n.classList.toggle("active",u),n.toggleAttribute("aria-current",u)}),t&&Vt(e)}function Ut(){document.querySelectorAll('[data-action="logout"]').forEach(e=>{e.dataset.bound!=="true"&&(e.dataset.bound="true",e.addEventListener("click",async t=>{t.preventDefault(),await Ee(),kt(),m("success",a("auth.messages.logoutSuccess")),window.location.hash="#login",H()}))})}window.addEventListener("hashchange",H);document.addEventListener("DOMContentLoaded",async()=>{de(),Dt(),Ye(),Mt(),await bt(),await Ve(),Xe(),st(),gt(),it(),pt(),Tt(),xt(),Et(),Lt(),H(),Ut()});
