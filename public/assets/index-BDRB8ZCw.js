(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))r(s);new MutationObserver(s=>{for(const o of s)if(o.type==="childList")for(const a of o.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&r(a)}).observe(document,{childList:!0,subtree:!0});function n(s){const o={};return s.integrity&&(o.integrity=s.integrity),s.referrerPolicy&&(o.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?o.credentials="include":s.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function r(s){if(s.ep)return;s.ep=!0;const o=n(s);fetch(s.href,o)}})();const L="[301-ui]";function N(e,...t){console.info(L,e,...t)}function f(e,...t){console.debug(L,e,...t)}const w="auth_token",V=10*60*1e3;let p=null,T=new Set,u={token:null,user:null,loading:!1};function b(){T.forEach(e=>e({...u}))}function $(e){return T.add(e),e({...u}),()=>T.delete(e)}function P(){return u.token??localStorage.getItem(w)}function m(e){u={...u,token:e},e?(localStorage.setItem(w,e),K()):(localStorage.removeItem(w),F()),b()}function x(){m(null)}function d(e){u={...u,user:e},b()}async function y(){try{u={...u,loading:!0},b();const e=await ne();return d(e.user??e??null),e.user??e??null}catch(e){return f("Failed to load user",e),d(null),null}finally{u={...u,loading:!1},b()}}async function I(){try{const e=await c("/refresh",{method:"POST"});e.access_token&&m(e.access_token),e.user&&d(e.user??null)}catch(e){f("Refresh failed",e),x(),d(null)}}function K(){F(),P()&&(p=setTimeout(I,V))}function F(){p&&clearTimeout(p),p=null}function H(e){e.key===w&&(u={...u,token:e.newValue},b(),e.newValue?y():d(null))}async function M(){const e=localStorage.getItem(w);e?(m(e),await y()):await I(),window.addEventListener("storage",H),N("Auth state initialized")}function J(e,t,n="Request failed"){const r=typeof t=="object"&&t&&"message"in t?String(t.message):n,s=new Error(r);return s.status=e,s.body=t,s}async function j(e){try{return await e.json()}catch(t){return console.debug("Failed to parse JSON",t),null}}const Y="https://api.301.st/auth";async function c(e,t={}){const n=new Headers(t.headers??{}),r=P();r&&!n.has("authorization")&&n.set("authorization",`Bearer ${r}`),t.body&&!(t.body instanceof FormData)&&n.set("content-type","application/json");const s=await fetch(`${Y}${e}`,{credentials:"include",...t,headers:n}),o=await j(s);if(!s.ok)throw J(s.status,o,s.statusText);return o??{}}async function B(e){const t=await c("/login",{method:"POST",body:JSON.stringify(e)});return t.access_token&&m(t.access_token),t.user&&d(t.user),t}async function z(e){const t=await c("/register",{method:"POST",body:JSON.stringify(e)});return t.access_token&&m(t.access_token),t.user&&d(t.user),t}async function W(e){return c("/reset/request",{method:"POST",body:JSON.stringify(e)})}async function Q(e){return c("/reset/confirm",{method:"POST",body:JSON.stringify(e)})}async function X(e){return c("/verify",{method:"POST",body:JSON.stringify(e)})}async function Z(){return c("/oauth/google/start",{method:"POST"})}async function ee(){return c("/oauth/github/start",{method:"POST"})}async function te(){try{await c("/logout",{method:"POST"})}catch(e){console.debug("Logout request failed",e)}x(),d(null)}async function ne(){return c("/me")}const v="0x4AAAAAACB-_l9VwF1M_QHU",k=new WeakMap;let C=v,h=null;async function re(){try{const e=await fetch("/env",{cache:"no-store"});if(!e.ok)return v;const t=await e.json();return t.turnstileSitekey||t.turnstile_sitekey||v}catch(e){return f("Failed to load Turnstile sitekey",e),v}}function se(){return typeof window>"u"?Promise.resolve(null):window.turnstile?Promise.resolve(window.turnstile):new Promise(e=>{if(!document.querySelector("script[data-turnstile]")){const r=document.createElement("script");r.src="https://challenges.cloudflare.com/turnstile/v0/api.js?render=explicit",r.async=!0,r.defer=!0,r.dataset.turnstile="true",document.head.appendChild(r)}const n=()=>e(window.turnstile||null);window.addEventListener("turnstileLoaded",n,{once:!0}),setTimeout(n,2e3)})}function oe(e){e instanceof Document&&(h==null||h.disconnect(),h=new MutationObserver(()=>G(e)),h.observe(e,{childList:!0,subtree:!0}))}async function ae(e=document){C=await re(),await se()&&(G(e),oe(e))}function q(e,t){if(!e)return;k.set(e,t);const n=e.querySelector('input[name="turnstile_token"]');n&&(n.value=t??"")}function G(e=document){const t=window.turnstile;!t||typeof t.render!="function"||e.querySelectorAll(".turnstile-widget").forEach(n=>{if(n.dataset.tsRendered==="1")return;n.dataset.tsRendered="1";const r=n.closest("form"),s=t.render(n,{sitekey:C,callback:o=>{q(r,o);const a=r==null?void 0:r.querySelector('button[type="submit"]');a&&(a.disabled=!1)},"expired-callback":()=>{q(r,null)},"error-callback":()=>{q(r,null);const o=r==null?void 0:r.querySelector('button[type="submit"]');o&&(o.disabled=!0)}});typeof s=="string"&&(n.dataset.widgetId=s)})}function _(e){var t;return e?k.has(e)?k.get(e)??null:((t=e.querySelector('input[name="turnstile_token"]'))==null?void 0:t.value)||null:null}function E(e){const t=window.turnstile;if(!(!t||typeof t.reset!="function")){if(e){const n=e.querySelector(".turnstile-widget");if(n!=null&&n.dataset.widgetId){t.reset(n.dataset.widgetId),q(e,null);return}}try{t.reset()}catch(n){f("Turnstile reset failed",n)}}}const S=(e,t=document)=>t.querySelector(e),A=(e,t=document)=>Array.from(t.querySelectorAll(e));function i(e,t,n){e.dataset.state=t;const r=S("[data-status]",e);r&&(r.hidden=!n,r.dataset.type=t,r.textContent=n??"");const s=e.querySelector('button[type="submit"]');s&&(s.dataset.labelReady||(s.dataset.labelReady=s.textContent??""),s.disabled=t==="pending",s.textContent=t==="pending"?s.dataset.labelLoading||"Please wait...":s.dataset.labelReady)}function l(e,t){const n=S("[data-global-message]");n&&(n.hidden=!1,n.dataset.type=e,n.textContent=t)}function ie(){const e=S("[data-global-message]");e&&(e.hidden=!0,e.textContent="",delete e.dataset.type)}function ue(e){var n,r;const t=e;return((n=t==null?void 0:t.body)==null?void 0:n.message)||((r=t==null?void 0:t.body)==null?void 0:r.error)||(t==null?void 0:t.message)||"Login failed"}function ce(e){const t=e.querySelector("[data-avatar-source]"),n=S("[data-avatar-label]"),r=S("[data-avatar-img]");if(!t)return;const s=o=>{const a=o.trim();n&&(n.textContent=a||"Укажите email"),r&&(r.src="/img/anonymous-avatar.svg")};s(t.value||""),t.addEventListener("input",o=>s(o.target.value))}async function le(e){var o,a;e.preventDefault();const t=e.currentTarget;ie();const n=(o=t.querySelector('[name="email"]'))==null?void 0:o.value.trim(),r=((a=t.querySelector('[name="password"]'))==null?void 0:a.value)||"",s=_(t);if(!n||!r){i(t,"error","Enter email and password");return}try{i(t,"pending","Signing in...");const g=await B({email:n,password:r,turnstile_token:s||void 0});await y(),i(t,"success",g.message||"Logged in"),l("success","Logged in"),t.reset()}catch(g){const U=ue(g);i(t,"error",U),E(t)}}function de(){document.querySelectorAll('[data-form="login"]').forEach(e=>{e.dataset.bound!=="true"&&(e.dataset.bound="true",e.addEventListener("submit",le),ce(e))})}function fe(e){var n,r;const t=e;return((n=t==null?void 0:t.body)==null?void 0:n.message)||((r=t==null?void 0:t.body)==null?void 0:r.error)||(t==null?void 0:t.message)||"Registration failed"}async function ge(e){var o,a;e.preventDefault();const t=e.currentTarget,n=(o=t.querySelector('[name="email"]'))==null?void 0:o.value.trim(),r=((a=t.querySelector('[name="password"]'))==null?void 0:a.value)||"",s=_(t);if(!n||!r){i(t,"error","Email and password are required");return}try{i(t,"pending","Creating account...");const g=await z({email:n,password:r,turnstile_token:s||void 0});await y(),i(t,"success",g.message||"Check your inbox to verify email"),l("success","Account created"),t.reset()}catch(g){i(t,"error",fe(g)),E(t)}}function me(){document.querySelectorAll('[data-form="register"]').forEach(e=>{e.dataset.bound!=="true"&&(e.dataset.bound="true",e.addEventListener("submit",ge))})}function ye(e){var n,r;const t=e;return((n=t==null?void 0:t.body)==null?void 0:n.message)||((r=t==null?void 0:t.body)==null?void 0:r.error)||(t==null?void 0:t.message)||"Reset failed"}async function he(e){var s,o;e.preventDefault();const t=e.currentTarget,n=(s=t.querySelector('[name="token"]'))==null?void 0:s.value.trim(),r=((o=t.querySelector('[name="password"]'))==null?void 0:o.value)||"";if(!n||!r){i(t,"error","Token and new password are required");return}try{i(t,"pending","Updating password...");const a=await Q({token:n,password:r});i(t,"success",a.message||"Password updated"),l("success","Password reset complete"),t.reset()}catch(a){i(t,"error",ye(a))}}function we(){document.querySelectorAll('[data-form="reset-confirm"]').forEach(e=>{e.dataset.bound!=="true"&&(e.dataset.bound="true",e.addEventListener("submit",he))})}function be(e){var n,r;const t=e;return((n=t==null?void 0:t.body)==null?void 0:n.message)||((r=t==null?void 0:t.body)==null?void 0:r.error)||(t==null?void 0:t.message)||"Reset request failed"}async function Se(e){var s;e.preventDefault();const t=e.currentTarget,n=(s=t.querySelector('[name="email"]'))==null?void 0:s.value.trim(),r=_(t);if(!n){i(t,"error","Email is required");return}try{i(t,"pending","Sending reset link...");const o=await W({email:n,turnstile_token:r||void 0});i(t,"success",o.message||"Check your inbox for reset instructions"),l("info","Reset email sent"),t.reset()}catch(o){i(t,"error",be(o)),E(t)}}function pe(){document.querySelectorAll('[data-form="reset-request"]').forEach(e=>{e.dataset.bound!=="true"&&(e.dataset.bound="true",e.addEventListener("submit",Se))})}function ve(e){var n,r;const t=e;return((n=t==null?void 0:t.body)==null?void 0:n.message)||((r=t==null?void 0:t.body)==null?void 0:r.error)||(t==null?void 0:t.message)||"Verification failed"}async function qe(e){var s,o;e.preventDefault();const t=e.currentTarget,n=(s=t.querySelector('[name="email"]'))==null?void 0:s.value.trim(),r=(o=t.querySelector('[name="code"]'))==null?void 0:o.value.trim();if(!n||!r){i(t,"error","Email and code are required");return}try{i(t,"pending","Verifying...");const a=await X({email:n,code:r});i(t,"success",a.message||"Verification complete"),l("success","Email confirmed"),t.reset()}catch(a){i(t,"error",ve(a))}}function Ae(){document.querySelectorAll('[data-form="verify"]').forEach(e=>{e.dataset.bound!=="true"&&(e.dataset.bound="true",e.addEventListener("submit",qe))})}const R="github_oauth_state";function Te(e){return e.url||e.auth_url||""}async function ke(){const e=await ee(),t=Te(e);if(e.state&&sessionStorage.setItem(R,e.state),!t)throw new Error("GitHub OAuth URL missing");window.location.href=t}async function Re(){const e=new URL(window.location.href),t=e.searchParams.get("token"),n=e.searchParams.get("state");if(!t)return;const r=sessionStorage.getItem(R);if(r&&n&&r!==n){f("GitHub OAuth state mismatch, ignoring response");return}m(t),await y(),l("success","Signed in with GitHub"),sessionStorage.removeItem(R),window.history.replaceState({},document.title,"/account")}function Oe(){document.querySelectorAll('[data-social="github"]').forEach(e=>{e.dataset.bound!=="true"&&(e.dataset.bound="true",e.addEventListener("click",async t=>{t.preventDefault();try{await ke()}catch(n){f("GitHub OAuth start failed",n),l("error","GitHub sign-in is unavailable")}}))}),Re()}const D="google_code_verifier",O="google_oauth_state";function _e(e){return e.url||e.auth_url||""}async function Ee(){const e=await Z(),t=_e(e);if((e.code_verifier||e.verifier)&&sessionStorage.setItem(D,e.code_verifier||e.verifier||""),e.state&&sessionStorage.setItem(O,e.state),!t)throw new Error("OAuth redirect URL is missing");window.location.href=t}async function Le(){const e=new URL(window.location.href),t=e.searchParams.get("token"),n=e.searchParams.get("state");if(!t)return;const r=sessionStorage.getItem(O);if(r&&n&&r!==n){f("OAuth state mismatch, ignoring response");return}m(t),await y(),l("success","Signed in with Google"),sessionStorage.removeItem(D),sessionStorage.removeItem(O),window.history.replaceState({},document.title,"/account")}function Pe(){document.querySelectorAll('[data-social="google"]').forEach(e=>{e.dataset.bound!=="true"&&(e.dataset.bound="true",e.addEventListener("click",async t=>{t.preventDefault();try{await Ee()}catch(n){f("Google OAuth start failed",n),l("error","Google sign-in is unavailable right now")}}))}),Le()}function xe(e,t){A("[data-onlogin]").forEach(n=>{n.hidden=!e,n.toggleAttribute("aria-hidden",!e)}),A("[data-onlogout]").forEach(n=>{n.hidden=e,n.toggleAttribute("aria-hidden",e)}),A("[data-auth-email], [data-user-email]").forEach(n=>{n.textContent=t})}function Ie(){$(e=>{var t;xe(!!(e.user&&e.token),((t=e.user)==null?void 0:t.email)??"")})}function Fe(){document.querySelectorAll('[data-action="logout"]').forEach(e=>{e.dataset.bound!=="true"&&(e.dataset.bound="true",e.addEventListener("click",async t=>{t.preventDefault(),await te(),l("success","Logged out")}))})}document.addEventListener("DOMContentLoaded",async()=>{Ie(),await M(),await ae(),de(),me(),pe(),we(),Ae(),Pe(),Oe(),Fe()});
