(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))o(n);new MutationObserver(n=>{for(const a of n)if(a.type==="childList")for(const i of a.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&o(i)}).observe(document,{childList:!0,subtree:!0});function r(n){const a={};return n.integrity&&(a.integrity=n.integrity),n.referrerPolicy&&(a.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?a.credentials="include":n.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function o(n){if(n.ep)return;n.ep=!0;const a=r(n);fetch(n.href,a)}})();const w=(e,t=document)=>t.querySelector(e),b=(e,t=document)=>Array.from(t.querySelectorAll(e));function c(e,t,r){e.dataset.state=t;const o=w("[data-status]",e);o&&(o.hidden=!r,o.dataset.type=t,o.textContent=r??"");const n=e.querySelector('button[type="submit"]');if(n){const a=n.dataset.labelReady||n.textContent||"";n.dataset.labelReady||(n.dataset.labelReady=a),n.disabled=t==="loading",t==="loading"?n.textContent=n.dataset.labelLoading||"Loading...":n.textContent=n.dataset.labelReady||a}}function h(e,t){const r=w("[data-global-message]");r&&(r.hidden=!1,r.dataset.type=e,r.textContent=t)}function L(){const e=w("[data-global-message]");e&&(e.hidden=!0,e.textContent="",delete e.dataset.type)}let v=0;function k(e,t){try{typeof window.webstudioSetVariable=="function"&&window.webstudioSetVariable(e,t)}catch(r){console.debug("webstudio var failed",r)}}function T(){v+=1,k("authFetchBuster",`${v}`),B().catch(e=>console.debug("buster fetch failed",e))}const p="auth_token";let u={isLoggedIn:!1,user:null,token:null};function E(){return u.token?u.token:localStorage.getItem(p)}function d(e){u={...u,token:e},e?localStorage.setItem(p,e):localStorage.removeItem(p)}function A(){b("[data-onlogin]").forEach(t=>{t.hidden=!u.isLoggedIn}),b("[data-onlogout]").forEach(t=>{t.hidden=u.isLoggedIn}),b("[data-user-email]").forEach(t=>{var r;t.textContent=((r=u.user)==null?void 0:r.email)||""})}function l(e){u={...u,isLoggedIn:!!e,user:e},A(),k("authEmail",(e==null?void 0:e.email)||""),T()}async function S(){try{L();const e=await C();return l(e||null),e||null}catch(e){return console.debug("me failed",e),l(null),null}}async function O(){if(E())try{await S();return}catch{}try{const t=await D();if(t.access_token||t.user){t.access_token&&d(t.access_token),l(t.user||null);return}}catch(t){console.debug("refresh failed",t)}l(null)}function x(){d(null),l(null),h("success","Logged out")}const F="https://api.301.st/auth";async function f(e,t={}){const r={...t.headers};t.body&&!(t.body instanceof FormData)&&(r["content-type"]="application/json");const o=await fetch(`${F}${e}`,{credentials:"include",...t,headers:r}),n=await o.json().catch(()=>({}));if(!o.ok){const a=n.error||n.message||o.statusText;throw new Error(a)}return n}async function P(e){const t=await f("/login",{method:"POST",body:JSON.stringify(e)});return t.access_token&&d(t.access_token),t}async function I(e){const t=await f("/register",{method:"POST",body:JSON.stringify(e)});return t.access_token&&d(t.access_token),t}async function C(){const e=E(),t={};return e&&(t.Authorization=`Bearer ${e}`),f("/me",{headers:t})}async function D(){const e=await f("/refresh",{method:"POST"});return e.access_token&&d(e.access_token),e}async function R(){const e=await f("/logout",{method:"POST"});return d(null),e}async function B(){try{await f("/me",{method:"HEAD"})}catch(e){console.debug("auth fetch buster failed",e)}}const y="0x4AAAAAACB-_l9VwF1M_QHU";let g=null,_=y;function M(){return typeof window>"u"?Promise.resolve(null):window.turnstile?Promise.resolve(window.turnstile):g||(g=new Promise(e=>{if(!document.querySelector("script[data-turnstile]")){const o=document.createElement("script");o.src="https://challenges.cloudflare.com/turnstile/v0/api.js?render=explicit",o.async=!0,o.defer=!0,o.dataset.turnstile="true",document.head.appendChild(o)}const r=()=>{e(window.turnstile||null)};window.addEventListener("turnstileLoaded",r,{once:!0}),setTimeout(r,1500)}),g)}async function K(e=document){_=await N(),await M()&&j(e)}async function N(){try{const e=await fetch("/env",{cache:"no-store"});if(!e.ok)return y;const t=await e.json();return(t==null?void 0:t.turnstileSitekey)||(t==null?void 0:t.turnstile_sitekey)||y}catch(e){return console.debug("turnstile env failed",e),y}}function j(e=document){const t=window.turnstile;if(!t||typeof t.render!="function")return;e.querySelectorAll(".turnstile-widget").forEach(o=>{if(o.dataset.tsRendered==="1"||o.children.length>0)return;o.dataset.tsRendered="1";const n=o.closest("form"),a=n==null?void 0:n.querySelector('input[name="turnstile_token"]'),i=n==null?void 0:n.querySelector("[data-auth-submit]"),s=t.render(o,{sitekey:_,callback(m){a&&(a.value=m),i&&(i.disabled=!1)},"expired-callback"(){a&&(a.value=""),i&&(i.disabled=!0);try{t.reset(s)}catch{}},"error-callback"(){i&&(i.disabled=!0)}})})}function q(e){var t,r;return((r=(t=e.querySelector('input[name="turnstile_token"]'))==null?void 0:t.value)==null?void 0:r.trim())||null}function V(e){if(!e)return;const t=document.querySelector("[data-avatar-label]"),r=document.querySelector("[data-avatar-img]"),o=n=>{const a=n.trim();t&&(t.textContent=a||"Укажите email"),r&&a&&(r.src="/img/anonymous-avatar.svg")};o(e.value||""),e.addEventListener("input",n=>o(n.target.value))}async function $(e){var a,i;e.preventDefault();const t=e.currentTarget;L();const r=(a=t.querySelector('[name="email"]'))==null?void 0:a.value.trim(),o=((i=t.querySelector('[name="password"]'))==null?void 0:i.value)||"",n=q(t);if(!r||!o){c(t,"error","Enter email and password");return}if(!n){c(t,"error","Подтвердите капчу");return}try{c(t,"loading","Signing in...");const s=await P({email:r,password:o,turnstile_token:n});if(s.access_token){const m=s.user||await S();l(m||s.user||null),h("success","Logged in"),c(t,"success","Logged in"),t.reset();return}c(t,"error",s.message||s.error||"Login failed")}catch(s){console.error(s),c(t,"error",s.message||"Login failed")}}function G(){const e=document.querySelector('[data-auth="login"]');e&&e.dataset.bound!=="true"&&(e.dataset.bound="true",e.addEventListener("submit",$),V(e.querySelector("[data-avatar-source]")))}async function H(e){var a,i;e.preventDefault();const t=e.currentTarget,r=(a=t.querySelector('[name="email"]'))==null?void 0:a.value.trim(),o=((i=t.querySelector('[name="password"]'))==null?void 0:i.value)||"",n=q(t);if(!r||!o){c(t,"error","Введите email и пароль");return}if(!n){c(t,"error","Подтвердите капчу");return}try{c(t,"loading","Создаём аккаунт...");const s=await I({email:r,password:o,turnstile_token:n});if(s.ok||s.access_token){const m=s.user||await S();l(m||s.user||null),c(t,"success","Проверьте почту или войдите сразу."),h("success","Регистрация завершена"),t.reset();return}c(t,"error",s.message||s.error||"Не удалось создать аккаунт")}catch(s){console.error(s),c(t,"error",s.message||"Ошибка регистрации")}}function J(){const e=document.querySelector('[data-auth="register"]');e&&e.dataset.bound!=="true"&&(e.dataset.bound="true",e.addEventListener("submit",H))}document.addEventListener("DOMContentLoaded",()=>{O(),K(),G(),J();const e=document.querySelector('[data-action="logout"]');e&&e.addEventListener("click",async t=>{t.preventDefault(),await R().catch(r=>console.debug("logout failed",r)),x(),h("success","Logged out")})});
